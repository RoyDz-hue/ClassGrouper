<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#4b4bca',
                        light: {
                            bg: '#FFFFFF',
                            text: '#333333',
                            card: '#F5F5F5',
                            border: '#E5E5E5'
                        },
                        dark: {
                            bg: '#181818',
                            text: '#E5E5E5',
                            card: '#2A2A2A',
                            border: '#3A3A3A'
                        }
                    }
                }
            }
        }

        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
    <style>
        .loader {
            border-top-color: #5D5CDE;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="min-h-screen bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text transition-colors duration-200">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-dark-card p-6 rounded-lg shadow-lg flex flex-col items-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            <h2 class="text-center text-xl font-semibold" id="loadingText">Loading...</h2>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 z-50 rounded-lg shadow-lg max-w-xs hidden transform transition-all duration-300 translate-y-[-100%] opacity-0">
        <div class="px-4 py-3 rounded-lg flex items-center gap-2">
            <span id="toastIcon"></span>
            <p id="toastMessage" class="text-sm"></p>
        </div>
    </div>

    <!-- Authentication Pages -->
    <div id="authPages" class="container mx-auto px-4 py-8 max-w-md">
        <div class="flex justify-center mb-6">
            <h1 class="text-3xl font-bold">Group Management System</h1>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="bg-light-card dark:bg-dark-card rounded-lg shadow-lg p-6 mb-4">
            <h2 class="text-2xl font-semibold mb-4">Login</h2>
            <div class="space-y-4">
                <div>
                    <label for="loginEmail" class="block mb-1">Email or Admission Number</label>
                    <input type="text" id="loginEmail" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base" placeholder="Enter your email or admission number">
                </div>
                <div>
                    <label for="loginPassword" class="block mb-1">Password</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base" placeholder="Enter your password">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="rememberMe" class="rounded text-primary">
                    <label for="rememberMe" class="ml-2 text-sm">Remember me</label>
                </div>
                <button id="loginBtn" class="w-full bg-primary hover:bg-secondary text-white py-2 rounded-lg transition-colors">Login</button>
                <div class="flex justify-between text-sm">
                    <button id="forgotPasswordBtn" class="text-primary hover:underline">Forgot Password?</button>
                    <button id="showRegisterBtn" class="text-primary hover:underline">Create Account</button>
                </div>
            </div>
        </div>

        <!-- Registration Form -->
        <div id="registerForm" class="bg-light-card dark:bg-dark-card rounded-lg shadow-lg p-6 hidden">
            <h2 class="text-2xl font-semibold mb-4">Create Account</h2>
            <div class="space-y-4">
                <div>
                    <label for="fullName" class="block mb-1">Full Name</label>
                    <input type="text" id="fullName" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base" placeholder="Enter your full name">
                </div>
                <div>
                    <label for="admissionNumber" class="block mb-1">Admission Number</label>
                    <input type="text" id="admissionNumber" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base" placeholder="Enter your admission number">
                </div>
                <div>
                    <label for="registerEmail" class="block mb-1">Email</label>
                    <input type="email" id="registerEmail" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base" placeholder="Enter your email">
                </div>
                <div>
                    <label for="phoneNumber" class="block mb-1">Phone Number</label>
                    <input type="tel" id="phoneNumber" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base" placeholder="Enter your phone number">
                </div>
                <div>
                    <label for="registerPassword" class="block mb-1">Password</label>
                    <input type="password" id="registerPassword" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base" placeholder="Minimum 6 characters">
                </div>
                <div>
                    <label for="confirmPassword" class="block mb-1">Confirm Password</label>
                    <input type="password" id="confirmPassword" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base" placeholder="Confirm your password">
                </div>
                <button id="registerBtn" class="w-full bg-primary hover:bg-secondary text-white py-2 rounded-lg transition-colors">Register</button>
                <div class="text-center text-sm">
                    <button id="showLoginBtn" class="text-primary hover:underline">Already have an account? Login</button>
                </div>
            </div>
        </div>

        <!-- Forgot Password Form -->
        <div id="forgotPasswordForm" class="bg-light-card dark:bg-dark-card rounded-lg shadow-lg p-6 hidden">
            <h2 class="text-2xl font-semibold mb-4">Reset Password</h2>
            <div class="space-y-4">
                <div>
                    <label for="resetEmail" class="block mb-1">Email</label>
                    <input type="email" id="resetEmail" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base" placeholder="Enter your email">
                </div>
                <button id="resetPasswordBtn" class="w-full bg-primary hover:bg-secondary text-white py-2 rounded-lg transition-colors">Send Reset Link</button>
                <div class="text-center text-sm">
                    <button id="backToLoginBtn" class="text-primary hover:underline">Back to Login</button>
                </div>
            </div>
        </div>

        <!-- Email Verification -->
        <div id="emailVerificationMsg" class="bg-light-card dark:bg-dark-card rounded-lg shadow-lg p-6 hidden">
            <h2 class="text-2xl font-semibold mb-4">Email Verification</h2>
            <p class="mb-4">A verification link has been sent to your email. Please verify your email to continue.</p>
            <div class="space-y-4">
                <button id="resendVerificationBtn" class="w-full bg-primary hover:bg-secondary text-white py-2 rounded-lg transition-colors">Resend Verification Email</button>
                <button id="verificationBackToLoginBtn" class="w-full border border-primary text-primary hover:bg-primary hover:text-white py-2 rounded-lg transition-colors">Back to Login</button>
            </div>
        </div>
    </div>

    <!-- User Dashboard -->
    <div id="userDashboard" class="hidden">
        <header class="bg-primary text-white py-4 shadow-md">
            <div class="container mx-auto px-4 flex justify-between items-center">
                <h1 class="text-xl font-bold">Group Management System</h1>
                <div class="flex items-center gap-4">
                    <span id="userDisplayName" class="hidden md:block"></span>
                    <div class="relative">
                        <button id="userMenuBtn" class="flex items-center gap-2">
                            <i class="fas fa-user-circle text-2xl"></i>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="userMenu" class="absolute right-0 mt-2 w-48 bg-white dark:bg-dark-card rounded-lg shadow-lg py-2 hidden z-10">
                            <button id="viewProfileBtn" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-user mr-2"></i> View Profile
                            </button>
                            <button id="logoutBtn" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-sign-out-alt mr-2"></i> Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- User Profile Section -->
                <div id="userProfileSection" class="lg:col-span-1 bg-light-card dark:bg-dark-card rounded-lg shadow-lg p-6 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">User Profile</h2>
                        <button id="closeProfileBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="profileData" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Full Name</label>
                            <input type="text" id="profileFullName" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Admission Number</label>
                            <input type="text" id="profileAdmissionNumber" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Email</label>
                            <input type="email" id="profileEmail" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Phone Number</label>
                            <input type="tel" id="profilePhoneNumber" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Account Status</label>
                            <div id="accountStatus" class="px-4 py-2 rounded-lg inline-block font-medium"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Last Login</label>
                            <div id="lastLogin" class="px-4 py-2"></div>
                        </div>
                        <button id="updateProfileBtn" class="w-full bg-primary hover:bg-secondary text-white py-2 rounded-lg transition-colors">Update Profile</button>
                    </div>
                </div>

                <!-- Available Groups Section -->
                <div class="lg:col-span-2 bg-light-card dark:bg-dark-card rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">Available Groups</h2>
                    <div id="availableGroupsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Groups will be dynamically added here -->
                    </div>
                </div>

                <!-- Current Group Section -->
                <div id="currentGroupSection" class="lg:col-span-3 bg-light-card dark:bg-dark-card rounded-lg shadow-lg p-6 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold" id="currentGroupName">Group Name</h2>
                        <div class="flex gap-2">
                            <span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100">
                                <span id="currentGroupMembersCount">0</span>/<span id="currentGroupCapacity">0</span> Members
                            </span>
                        </div>
                    </div>

                    <!-- Group Members -->
                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-2">Members</h3>
                        <div id="groupMembersContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                            <!-- Group members will be added here -->
                        </div>
                    </div>

                    <!-- Group Chat -->
                    <div>
                        <h3 class="text-lg font-medium mb-2">Group Chat</h3>
                        <div id="chatContainer" class="bg-light-bg dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg h-64 overflow-y-auto p-4 mb-4">
                            <!-- Chat messages will be added here -->
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="chatMessage" class="flex-1 px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base" placeholder="Type your message...">
                            <button id="sendMessageBtn" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <header class="bg-primary text-white py-4 shadow-md">
            <div class="container mx-auto px-4 flex justify-between items-center">
                <h1 class="text-xl font-bold">Admin Dashboard</h1>
                <div class="flex items-center gap-4">
                    <span id="adminDisplayName" class="hidden md:block"></span>
                    <div class="relative">
                        <button id="adminMenuBtn" class="flex items-center gap-2">
                            <i class="fas fa-user-circle text-2xl"></i>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="adminMenu" class="absolute right-0 mt-2 w-48 bg-white dark:bg-dark-card rounded-lg shadow-lg py-2 hidden z-10">
                            <button id="adminLogoutBtn" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-sign-out-alt mr-2"></i> Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-6">
            <div class="mb-6 flex flex-wrap gap-4">
                <button id="showUsersBtn" class="px-4 py-2 bg-primary hover:bg-secondary text-white rounded-lg transition-colors">
                    <i class="fas fa-users mr-2"></i> User Management
                </button>
                <button id="showGroupsBtn" class="px-4 py-2 bg-primary hover:bg-secondary text-white rounded-lg transition-colors">
                    <i class="fas fa-layer-group mr-2"></i> Group Management
                </button>
                <button id="exportDataBtn" class="px-4 py-2 bg-primary hover:bg-secondary text-white rounded-lg transition-colors">
                    <i class="fas fa-file-export mr-2"></i> Export Data
                </button>
            </div>

            <!-- User Management Section -->
            <div id="userManagementSection" class="bg-light-card dark:bg-dark-card rounded-lg shadow-lg p-6 mb-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">User Management</h2>
                    <button id="exportUsersBtn" class="px-4 py-2 bg-primary hover:bg-secondary text-white rounded-lg transition-colors text-sm">
                        <i class="fas fa-file-excel mr-2"></i> Export Users
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-light-border dark:divide-dark-border">
                        <thead>
                            <tr>
                                <th class="px-4 py-2 text-left">Name</th>
                                <th class="px-4 py-2 text-left">Admission #</th>
                                <th class="px-4 py-2 text-left">Email</th>
                                <th class="px-4 py-2 text-left">Phone</th>
                                <th class="px-4 py-2 text-left">Group</th>
                                <th class="px-4 py-2 text-left">Status</th>
                                <th class="px-4 py-2 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody" class="divide-y divide-light-border dark:divide-dark-border">
                            <!-- Users will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Group Management Section -->
            <div id="groupManagementSection" class="bg-light-card dark:bg-dark-card rounded-lg shadow-lg p-6 mb-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Group Management</h2>
                    <button id="createGroupBtn" class="px-4 py-2 bg-primary hover:bg-secondary text-white rounded-lg transition-colors text-sm">
                        <i class="fas fa-plus mr-2"></i> Create Group
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="adminGroupsContainer">
                    <!-- Groups will be added here -->
                </div>
            </div>

            <!-- Export Data Section -->
            <div id="exportDataSection" class="bg-light-card dark:bg-dark-card rounded-lg shadow-lg p-6 mb-6 hidden">
                <h2 class="text-xl font-semibold mb-4">Export Data</h2>
                <div class="space-y-4">
                    <button id="exportAllGroupsBtn" class="w-full sm:w-auto px-4 py-2 bg-primary hover:bg-secondary text-white rounded-lg transition-colors">
                        <i class="fas fa-file-excel mr-2"></i> Export All Groups to Excel
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Edit User Modal -->
    <div id="editUserModal" class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-dark-card p-6 rounded-lg shadow-lg w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Edit User</h2>
                <button id="closeEditUserModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="editUserId">
                <div>
                    <label for="editUserName" class="block mb-1">Full Name</label>
                    <input type="text" id="editUserName" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base">
                </div>
                <div>
                    <label for="editUserAdmissionNumber" class="block mb-1">Admission Number</label>
                    <input type="text" id="editUserAdmissionNumber" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base">
                </div>
                <div>
                    <label for="editUserEmail" class="block mb-1">Email</label>
                    <input type="email" id="editUserEmail" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base">
                </div>
                <div>
                    <label for="editUserPhone" class="block mb-1">Phone Number</label>
                    <input type="tel" id="editUserPhone" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base">
                </div>
                <div>
                    <label for="editUserGroup" class="block mb-1">Group</label>
                    <select id="editUserGroup" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base">
                        <option value="">No Group</option>
                        <!-- Groups will be added here -->
                    </select>
                </div>
                <div>
                    <label for="editUserStatus" class="block mb-1">Status</label>
                    <select id="editUserStatus" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                <div class="flex justify-between">
                    <button id="saveUserChangesBtn" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors">Save Changes</button>
                    <button id="deleteUserBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">Delete User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Group Modal -->
    <div id="groupModal" class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-dark-card p-6 rounded-lg shadow-lg w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold" id="groupModalTitle">Create Group</h2>
                <button id="closeGroupModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="editGroupId">
                <div>
                    <label for="groupName" class="block mb-1">Group Name</label>
                    <input type="text" id="groupName" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base">
                </div>
                <div>
                    <label for="groupCapacity" class="block mb-1">Capacity</label>
                    <input type="number" id="groupCapacity" class="w-full px-4 py-2 rounded-lg border border-light-border dark:border-dark-border bg-light-bg dark:bg-dark-bg text-base" min="1" value="11">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="chatEnabled" class="rounded text-primary" checked>
                    <label for="chatEnabled" class="ml-2">Enable Chat</label>
                </div>
                <div class="flex justify-between">
                    <button id="saveGroupBtn" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-colors">Save Group</button>
                    <button id="deleteGroupBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors hidden">Delete Group</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Group Modal -->
    <div id="viewGroupModal" class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-dark-card p-6 rounded-lg shadow-lg w-full max-w-3xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold" id="viewGroupName">Group Name</h2>
                <div class="flex gap-2">
                    <button id="editGroupBtn" class="text-primary hover:text-secondary">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button id="closeViewGroupModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="mb-4">
                <span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100">
                    <span id="viewGroupMembersCount">0</span>/<span id="viewGroupCapacity">0</span> Members
                </span>
            </div>
            <div class="space-y-4">
                <h3 class="text-lg font-medium">Members</h3>
                <div id="viewGroupMembersContainer" class="max-h-64 overflow-y-auto">
                    <table class="min-w-full divide-y divide-light-border dark:divide-dark-border">
                        <thead>
                            <tr>
                                <th class="px-4 py-2 text-left">Name</th>
                                <th class="px-4 py-2 text-left">Admission #</th>
                                <th class="px-4 py-2 text-left">Email</th>
                                <th class="px-4 py-2 text-left">Phone</th>
                                <th class="px-4 py-2 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="viewGroupMembersTable" class="divide-y divide-light-border dark:divide-dark-border">
                            <!-- Group members will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Libraries -->
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-analytics.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            sendEmailVerification,
            sendPasswordResetEmail,
            signOut,
            onAuthStateChanged,
            setPersistence,
            browserSessionPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            set, 
            get, 
            update, 
            remove, 
            push, 
            onValue,
            serverTimestamp,
            query,
            orderByChild,
            orderByKey
        } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";
        import {
            getFirestore,
            collection,
            addDoc,
            getDoc,
            getDocs,
            updateDoc,
            deleteDoc,
            doc,
            setDoc,
            serverTimestamp as firestoreTimestamp
        } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB-a01V6F-tyS5xhgUEflbnnDcp4BROJUU",
            authDomain: "fortunelabse.firebaseapp.com",
            databaseURL: "https://fortunelabse-default-rtdb.firebaseio.com",
            projectId: "fortunelabse",
            storageBucket: "fortunelabse.firebasestorage.app",
            messagingSenderId: "853842400913",
            appId: "1:853842400913:web:12ee9519c8667fa83d5130",
            measurementId: "G-XYV95HGG1G"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const firestore = getFirestore(app);

        // Global variables
        let currentUser = null;
        let currentUserData = null;
        let currentUserRole = null;
        let userGroups = [];
        let allUsers = [];
        let hasJoinedGroup = false;
        const ADMIN_EMAIL = "cyntoremix@gmail.com";

        // DOM elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = document.getElementById('toastIcon');

        // Auth pages
        const authPages = document.getElementById('authPages');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        const emailVerificationMsg = document.getElementById('emailVerificationMsg');

        // User dashboard
        const userDashboard = document.getElementById('userDashboard');
        const userDisplayName = document.getElementById('userDisplayName');
        const userProfileSection = document.getElementById('userProfileSection');
        const availableGroupsContainer = document.getElementById('availableGroupsContainer');
        const currentGroupSection = document.getElementById('currentGroupSection');
        const currentGroupName = document.getElementById('currentGroupName');
        const currentGroupMembersCount = document.getElementById('currentGroupMembersCount');
        const currentGroupCapacity = document.getElementById('currentGroupCapacity');
        const groupMembersContainer = document.getElementById('groupMembersContainer');
        const chatContainer = document.getElementById('chatContainer');
        const chatMessage = document.getElementById('chatMessage');

        // Admin dashboard
        const adminDashboard = document.getElementById('adminDashboard');
        const adminDisplayName = document.getElementById('adminDisplayName');
        const userManagementSection = document.getElementById('userManagementSection');
        const groupManagementSection = document.getElementById('groupManagementSection');
        const exportDataSection = document.getElementById('exportDataSection');
        const usersTableBody = document.getElementById('usersTableBody');
        const adminGroupsContainer = document.getElementById('adminGroupsContainer');

        // Utility functions
        function showLoading(message = 'Loading...') {
            loadingText.textContent = message;
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-blue-500');
            
            if (type === 'success') {
                toast.classList.add('bg-green-500');
                toastIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            } else if (type === 'error') {
                toast.classList.add('bg-red-500');
                toastIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
            } else if (type === 'info') {
                toast.classList.add('bg-blue-500');
                toastIcon.innerHTML = '<i class="fas fa-info-circle"></i>';
            }
            
            toast.classList.add('text-white');
            
            // Animation
            setTimeout(() => {
                toast.classList.remove('translate-y-[-100%]', 'opacity-0');
            }, 10);
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-y-[-100%]', 'opacity-0');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 300);
            }, 3000);
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Never';
            const date = new timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString();
        }

        // Authentication functions
        async function registerUser() {
            const fullName = document.getElementById('fullName').value.trim();
            const admissionNumber = document.getElementById('admissionNumber').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validate inputs
            if (!fullName || !admissionNumber || !email || !phoneNumber || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }

            showLoading('Creating account...');

            try {
                // Check if admission number already exists
                const admissionSnapshot = await get(ref(database, `userAdmissionNumbers/${admissionNumber}`));
                if (admissionSnapshot.exists()) {
                    hideLoading();
                    showToast('Admission number is already registered', 'error');
                    return;
                }

                // Create user with email and password
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Set user role
                const isAdmin = email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
                
                // Create user profile in database
                await set(ref(database, `users/${user.uid}`), {
                    fullName,
                    admissionNumber,
                    email,
                    phoneNumber,
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp(),
                    status: 'Active',
                    role: isAdmin ? 'admin' : 'user',
                    hasJoinedGroup: false
                });

                // Create admission number reference for login
                await set(ref(database, `userAdmissionNumbers/${admissionNumber}`), user.uid);

                // Send email verification
                await sendEmailVerification(user);

                hideLoading();
                showToast('Account created successfully! Please verify your email.', 'success');
                
                // Show email verification message
                showAuthForm('emailVerification');
                
            } catch (error) {
                hideLoading();
                console.error("Registration error:", error);
                let errorMessage = 'Failed to create account';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email is already in use';
                }
                
                showToast(errorMessage, 'error');
            }
        }

        async function loginUser() {
            const emailOrAdmission = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            if (!emailOrAdmission || !password) {
                showToast('Please enter your email/admission number and password', 'error');
                return;
            }

            showLoading('Logging in...');

            try {
                let email = emailOrAdmission;
                
                // Check if input is admission number
                if (!emailOrAdmission.includes('@')) {
                    const admissionSnapshot = await get(ref(database, `userAdmissionNumbers/${emailOrAdmission}`));
                    if (admissionSnapshot.exists()) {
                        const userId = admissionSnapshot.val();
                        const userSnapshot = await get(ref(database, `users/${userId}`));
                        if (userSnapshot.exists()) {
                            email = userSnapshot.val().email;
                        } else {
                            throw new Error('User not found');
                        }
                    } else {
                        throw new Error('Invalid admission number');
                    }
                }

                // Set persistence based on "remember me" checkbox
                await setPersistence(auth, rememberMe ? browserLocalPersistence : browserSessionPersistence);
                
                // Sign in with email and password
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Check if email is verified
                if (!user.emailVerified) {
                    await signOut(auth);
                    hideLoading();
                    showToast('Please verify your email before logging in', 'error');
                    showAuthForm('emailVerification');
                    return;
                }

                // Update last login time
                await update(ref(database, `users/${user.uid}`), {
                    lastLogin: serverTimestamp()
                });

                // Get user data including role
                const userSnapshot = await get(ref(database, `users/${user.uid}`));
                if (userSnapshot.exists()) {
                    currentUserData = userSnapshot.val();
                    currentUserRole = currentUserData.role;

                    // Redirect based on role
                    if (currentUserRole === 'admin') {
                        showAdminDashboard();
                    } else {
                        showUserDashboard();
                    }
                    
                    hideLoading();
                    showToast(`Welcome, ${currentUserData.fullName}!`, 'success');
                } else {
                    throw new Error('User data not found');
                }
                
            } catch (error) {
                hideLoading();
                console.error("Login error:", error);
                let errorMessage = 'Failed to login';
                
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Invalid email/admission number or password';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many login attempts, please try again later';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showToast(errorMessage, 'error');
            }
        }

        async function resetPassword() {
            const email = document.getElementById('resetEmail').value.trim();

            if (!email) {
                showToast('Please enter your email', 'error');
                return;
            }

            showLoading('Sending reset link...');

            try {
                await sendPasswordResetEmail(auth, email);
                hideLoading();
                showToast('Password reset link sent! Check your email.', 'success');
                showAuthForm('login');
            } catch (error) {
                hideLoading();
                console.error("Password reset error:", error);
                let errorMessage = 'Failed to send reset link';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Email not found';
                }
                
                showToast(errorMessage, 'error');
            }
        }

        async function resendVerificationEmail() {
            if (!auth.currentUser) {
                showToast('Please login first', 'error');
                return;
            }

            showLoading('Sending verification email...');

            try {
                await sendEmailVerification(auth.currentUser);
                hideLoading();
                showToast('Verification email sent!', 'success');
            } catch (error) {
                hideLoading();
                console.error("Verification email error:", error);
                showToast('Failed to send verification email', 'error');
            }
        }

        function logout() {
            showLoading('Logging out...');
            
            signOut(auth).then(() => {
                hideLoading();
                currentUser = null;
                currentUserData = null;
                currentUserRole = null;
                showAuthForm('login');
                showToast('Logged out successfully', 'success');
            }).catch((error) => {
                hideLoading();
                console.error("Logout error:", error);
                showToast('Failed to logout', 'error');
            });
        }

        // UI functions
        function showAuthForm(form) {
            loginForm.classList.add('hidden');
            registerForm.classList.add('hidden');
            forgotPasswordForm.classList.add('hidden');
            emailVerificationMsg.classList.add('hidden');
            userDashboard.classList.add('hidden');
            adminDashboard.classList.add('hidden');
            authPages.classList.remove('hidden');
            
            if (form === 'login') {
                loginForm.classList.remove('hidden');
            } else if (form === 'register') {
                registerForm.classList.remove('hidden');
            } else if (form === 'forgotPassword') {
                forgotPasswordForm.classList.remove('hidden');
            } else if (form === 'emailVerification') {
                emailVerificationMsg.classList.remove('hidden');
            }
        }

        function showUserDashboard() {
            authPages.classList.add('hidden');
            adminDashboard.classList.add('hidden');
            userDashboard.classList.remove('hidden');
            userProfileSection.classList.add('hidden');
            
            // Set user display name
            userDisplayName.textContent = currentUserData.fullName;
            
            // Load available groups
            loadAvailableGroups();
            
            // Check if user has joined a group
            checkUserGroup();
        }

        function showAdminDashboard() {
            authPages.classList.add('hidden');
            userDashboard.classList.add('hidden');
            adminDashboard.classList.remove('hidden');
            userManagementSection.classList.add('hidden');
            groupManagementSection.classList.add('hidden');
            exportDataSection.classList.add('hidden');
            
            // Set admin display name
            adminDisplayName.textContent = currentUserData.fullName;
            
            // Show user management by default
            document.getElementById('showUsersBtn').click();
        }

        // User dashboard functions
        async function loadUserProfile() {
            if (!currentUser) return;
            
            try {
                const userSnapshot = await get(ref(database, `users/${currentUser.uid}`));
                if (userSnapshot.exists()) {
                    const userData = userSnapshot.val();
                    
                    document.getElementById('profileFullName').value = userData.fullName;
                    document.getElementById('profileAdmissionNumber').value = userData.admissionNumber;
                    document.getElementById('profileEmail').value = userData.email;
                    document.getElementById('profilePhoneNumber').value = userData.phoneNumber || '';
                    
                    const accountStatusEl = document.getElementById('accountStatus');
                    accountStatusEl.textContent = userData.status || 'Active';
                    accountStatusEl.className = 'px-4 py-2 rounded-lg inline-block font-medium';
                    
                    if (userData.status === 'Active') {
                        accountStatusEl.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-700', 'dark:text-green-100');
                    } else {
                        accountStatusEl.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-700', 'dark:text-red-100');
                    }
                    
                    document.getElementById('lastLogin').textContent = formatDate(userData.lastLogin);
                }
            } catch (error) {
                console.error("Error loading profile:", error);
                showToast('Failed to load profile data', 'error');
            }
        }

        async function updateUserProfile() {
            if (!currentUser) return;
            
            const phoneNumber = document.getElementById('profilePhoneNumber').value.trim();
            
            if (!phoneNumber) {
                showToast('Please enter your phone number', 'error');
                return;
            }
            
            showLoading('Updating profile...');
            
            try {
                await update(ref(database, `users/${currentUser.uid}`), {
                    phoneNumber
                });
                
                hideLoading();
                showToast('Profile updated successfully', 'success');
                loadUserProfile();
            } catch (error) {
                hideLoading();
                console.error("Profile update error:", error);
                showToast('Failed to update profile', 'error');
            }
        }

        async function loadAvailableGroups() {
            try {
                showLoading('Loading groups...');
                
                const groupsSnapshot = await get(ref(database, 'groups'));
                userGroups = [];
                
                if (groupsSnapshot.exists()) {
                    const groupsData = groupsSnapshot.val();
                    
                    for (const groupId in groupsData) {
                        userGroups.push({
                            id: groupId,
                            ...groupsData[groupId]
                        });
                    }
                    
                    renderAvailableGroups();
                } else {
                    // Create 11 default groups if none exist
                    for (let i = 1; i <= 11; i++) {
                        const groupRef = push(ref(database, 'groups'));
                        const groupId = groupRef.key;
                        
                        const groupData = {
                            name: `Group ${i}`,
                            capacity: 11,
                            memberCount: 0,
                            chatEnabled: true,
                            createdAt: serverTimestamp()
                        };
                        
                        await set(groupRef, groupData);
                        
                        userGroups.push({
                            id: groupId,
                            ...groupData
                        });
                    }
                    
                    renderAvailableGroups();
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error("Error loading groups:", error);
                showToast('Failed to load groups', 'error');
            }
        }

        function renderAvailableGroups() {
            availableGroupsContainer.innerHTML = '';
            
            userGroups.forEach(group => {
                const isFull = group.memberCount >= group.capacity;
                const userInGroup = currentUserData.groupId === group.id;
                
                const groupCard = document.createElement('div');
                groupCard.className = 'bg-white dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg shadow-sm p-4';
                
                const groupHeader = document.createElement('div');
                groupHeader.className = 'flex justify-between items-center mb-2';
                
                const groupName = document.createElement('h3');
                groupName.className = 'font-medium';
                groupName.textContent = group.name;
                
                const groupCapacity = document.createElement('span');
                groupCapacity.className = 'px-2 py-1 rounded-full text-xs font-medium';
                
                if (isFull) {
                    groupCapacity.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-700', 'dark:text-red-100');
                } else {
                    groupCapacity.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-700', 'dark:text-green-100');
                }
                
                groupCapacity.textContent = `${group.memberCount}/${group.capacity}`;
                
                groupHeader.appendChild(groupName);
                groupHeader.appendChild(groupCapacity);
                
                const joinBtn = document.createElement('button');
                joinBtn.className = 'w-full mt-2 py-2 rounded-lg transition-colors';
                
                if (userInGroup) {
                    joinBtn.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white');
                    joinBtn.textContent = 'Current Group';
                    joinBtn.disabled = false;
                    joinBtn.onclick = () => viewCurrentGroup(group.id);
                } else if (isFull) {
                    joinBtn.classList.add('bg-gray-300', 'dark:bg-gray-700', 'text-gray-500', 'dark:text-gray-400', 'cursor-not-allowed');
                    joinBtn.textContent = 'Full';
                    joinBtn.disabled = true;
                } else if (currentUserData.hasJoinedGroup) {
                    joinBtn.classList.add('bg-gray-300', 'dark:bg-gray-700', 'text-gray-500', 'dark:text-gray-400', 'cursor-not-allowed');
                    joinBtn.textContent = 'Already in a group';
                    joinBtn.disabled = true;
                } else {
                    joinBtn.classList.add('bg-primary', 'hover:bg-secondary', 'text-white');
                    joinBtn.textContent = 'Join Group';
                    joinBtn.onclick = () => joinGroup(group.id);
                }
                
                groupCard.appendChild(groupHeader);
                groupCard.appendChild(joinBtn);
                
                availableGroupsContainer.appendChild(groupCard);
            });
        }

        async function joinGroup(groupId) {
            if (!currentUser) return;
            
            if (currentUserData.hasJoinedGroup) {
                showToast('You have already joined a group', 'error');
                return;
            }
            
            showLoading('Joining group...');
            
            try {
                // Get current group data
                const groupSnapshot = await get(ref(database, `groups/${groupId}`));
                
                if (!groupSnapshot.exists()) {
                    throw new Error('Group not found');
                }
                
                const groupData = groupSnapshot.val();
                
                // Check if group is full
                if (groupData.memberCount >= groupData.capacity) {
                    throw new Error('Group is full');
                }
                
                // Update group member count
                await update(ref(database, `groups/${groupId}`), {
                    memberCount: (groupData.memberCount || 0) + 1
                });
                
                // Add user to group
                await update(ref(database, `users/${currentUser.uid}`), {
                    groupId,
                    hasJoinedGroup: true,
                    joinedAt: serverTimestamp()
                });
                
                // Add user to group members
                await set(ref(database, `groupMembers/${groupId}/${currentUser.uid}`), {
                    userId: currentUser.uid,
                    fullName: currentUserData.fullName,
                    admissionNumber: currentUserData.admissionNumber,
                    email: currentUserData.email,
                    phoneNumber: currentUserData.phoneNumber,
                    joinedAt: serverTimestamp()
                });
                
                // Update current user data
                currentUserData.groupId = groupId;
                currentUserData.hasJoinedGroup = true;
                
                hideLoading();
                showToast('Joined group successfully', 'success');
                
                // Reload available groups
                loadAvailableGroups();
                
                // View current group
                viewCurrentGroup(groupId);
            } catch (error) {
                hideLoading();
                console.error("Error joining group:", error);
                showToast(error.message || 'Failed to join group', 'error');
            }
        }

        async function checkUserGroup() {
            if (!currentUser || !currentUserData) return;
            
            if (currentUserData.groupId) {
                viewCurrentGroup(currentUserData.groupId);
            } else {
                currentGroupSection.classList.add('hidden');
            }
        }

        async function viewCurrentGroup(groupId) {
            if (!groupId) return;
            
            showLoading('Loading group data...');
            
            try {
                // Get group data
                const groupSnapshot = await get(ref(database, `groups/${groupId}`));
                
                if (!groupSnapshot.exists()) {
                    throw new Error('Group not found');
                }
                
                const groupData = groupSnapshot.val();
                
                // Set group info
                currentGroupName.textContent = groupData.name;
                currentGroupMembersCount.textContent = groupData.memberCount || 0;
                currentGroupCapacity.textContent = groupData.capacity;
                
                // Load group members
                loadGroupMembers(groupId);
                
                // Set up chat
                setupGroupChat(groupId);
                
                // Show group section
                currentGroupSection.classList.remove('hidden');
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error("Error viewing group:", error);
                showToast('Failed to load group data', 'error');
            }
        }

        async function loadGroupMembers(groupId) {
            try {
                const membersSnapshot = await get(ref(database, `groupMembers/${groupId}`));
                
                groupMembersContainer.innerHTML = '';
                
                if (membersSnapshot.exists()) {
                    const membersData = membersSnapshot.val();
                    
                    for (const memberId in membersData) {
                        const member = membersData[memberId];
                        
                        const memberCard = document.createElement('div');
                        memberCard.className = 'bg-white dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg p-2';
                        
                        const memberName = document.createElement('div');
                        memberName.className = 'font-medium text-sm';
                        memberName.textContent = member.fullName;
                        
                        const memberAdmission = document.createElement('div');
                        memberAdmission.className = 'text-xs text-gray-500 dark:text-gray-400';
                        memberAdmission.textContent = member.admissionNumber;
                        
                        memberCard.appendChild(memberName);
                        memberCard.appendChild(memberAdmission);
                        
                        groupMembersContainer.appendChild(memberCard);
                    }
                } else {
                    groupMembersContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">No members in this group yet</p>';
                }
            } catch (error) {
                console.error("Error loading group members:", error);
                showToast('Failed to load group members', 'error');
            }
        }

        function setupGroupChat(groupId) {
            // Clear chat container
            chatContainer.innerHTML = '';
            
            // Load previous messages
            const chatRef = ref(database, `groupChats/${groupId}`);
            const chatQuery = query(chatRef, orderByKey());
            
            onValue(chatQuery, (snapshot) => {
                chatContainer.innerHTML = '';
                
                if (snapshot.exists()) {
                    const messages = snapshot.val();
                    
                    for (const messageId in messages) {
                        const message = messages[messageId];
                        addChatMessage(message);
                    }
                    
                    // Scroll to bottom
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            });
            
            // Send message function
            sendMessageBtn.onclick = () => {
                sendChatMessage(groupId);
            };
            
            // Enter key to send
            chatMessage.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendChatMessage(groupId);
                }
            };
        }

        function addChatMessage(message) {
            const isCurrentUser = message.userId === currentUser.uid;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-2 ${isCurrentUser ? 'text-right' : 'text-left'}`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `inline-block rounded-lg px-3 py-2 max-w-xs sm:max-w-sm break-words ${
                isCurrentUser ? 
                'bg-primary text-white' : 
                'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100'
            }`;
            
            const nameSpan = document.createElement('div');
            nameSpan.className = `text-xs font-medium ${isCurrentUser ? 'text-blue-100' : 'text-gray-600 dark:text-gray-300'}`;
            nameSpan.textContent = message.senderName;
            
            const messageText = document.createElement('div');
            messageText.textContent = message.text;
            
            const timeSpan = document.createElement('div');
            timeSpan.className = `text-xs ${isCurrentUser ? 'text-blue-100' : 'text-gray-500 dark:text-gray-400'}`;
            timeSpan.textContent = formatDate(message.timestamp);
            
            messageBubble.appendChild(nameSpan);
            messageBubble.appendChild(messageText);
            messageBubble.appendChild(timeSpan);
            
            messageDiv.appendChild(messageBubble);
            chatContainer.appendChild(messageDiv);
        }

        async function sendChatMessage(groupId) {
            const messageText = chatMessage.value.trim();
            
            if (!messageText) return;
            
            try {
                // Add message to database
                const messageRef = push(ref(database, `groupChats/${groupId}`));
                
                await set(messageRef, {
                    userId: currentUser.uid,
                    senderName: currentUserData.fullName,
                    text: messageText,
                    timestamp: serverTimestamp()
                });
                
                // Clear input
                chatMessage.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
                showToast('Failed to send message', 'error');
            }
        }

        // Admin dashboard functions
        async function loadUsers() {
            try {
                showLoading('Loading users...');
                
                const usersSnapshot = await get(ref(database, 'users'));
                allUsers = [];
                
                if (usersSnapshot.exists()) {
                    const usersData = usersSnapshot.val();
                    
                    for (const userId in usersData) {
                        allUsers.push({
                            id: userId,
                            ...usersData[userId]
                        });
                    }
                    
                    renderUsersTable();
                } else {
                    usersTableBody.innerHTML = '<tr><td colspan="7" class="px-4 py-4 text-center">No users found</td></tr>';
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error("Error loading users:", error);
                showToast('Failed to load users', 'error');
            }
        }

        async function renderUsersTable() {
            usersTableBody.innerHTML = '';
            
            // Get groups for dropdown
            const groupsSnapshot = await get(ref(database, 'groups'));
            const groups = {};
            
            if (groupsSnapshot.exists()) {
                const groupsData = groupsSnapshot.val();
                
                for (const groupId in groupsData) {
                    groups[groupId] = groupsData[groupId];
                }
            }
            
            // Render users
            allUsers.forEach(user => {
                const tr = document.createElement('tr');
                
                const nameTd = document.createElement('td');
                nameTd.className = 'px-4 py-2';
                nameTd.textContent = user.fullName;
                
                const admissionTd = document.createElement('td');
                admissionTd.className = 'px-4 py-2';
                admissionTd.textContent = user.admissionNumber;
                
                const emailTd = document.createElement('td');
                emailTd.className = 'px-4 py-2';
                emailTd.textContent = user.email;
                
                const phoneTd = document.createElement('td');
                phoneTd.className = 'px-4 py-2';
                phoneTd.textContent = user.phoneNumber || '-';
                
                const groupTd = document.createElement('td');
                groupTd.className = 'px-4 py-2';
                
                if (user.groupId && groups[user.groupId]) {
                    groupTd.textContent = groups[user.groupId].name;
                } else {
                    groupTd.textContent = 'No Group';
                }
                
                const statusTd = document.createElement('td');
                statusTd.className = 'px-4 py-2';
                
                const statusSpan = document.createElement('span');
                statusSpan.className = 'px-2 py-1 rounded-full text-xs font-medium';
                
                if (user.status === 'Active') {
                    statusSpan.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-700', 'dark:text-green-100');
                } else {
                    statusSpan.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-700', 'dark:text-red-100');
                }
                
                statusSpan.textContent = user.status || 'Active';
                statusTd.appendChild(statusSpan);
                
                const actionsTd = document.createElement('td');
                actionsTd.className = 'px-4 py-2';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'text-primary hover:text-secondary mr-2';
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.onclick = () => openEditUserModal(user);
                
                actionsTd.appendChild(editBtn);
                
                tr.appendChild(nameTd);
                tr.appendChild(admissionTd);
                tr.appendChild(emailTd);
                tr.appendChild(phoneTd);
                tr.appendChild(groupTd);
                tr.appendChild(statusTd);
                tr.appendChild(actionsTd);
                
                usersTableBody.appendChild(tr);
            });
        }

        async function openEditUserModal(user) {
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').value = user.fullName;
            document.getElementById('editUserAdmissionNumber').value = user.admissionNumber;
            document.getElementById('editUserEmail').value = user.email;
            document.getElementById('editUserPhone').value = user.phoneNumber || '';
            document.getElementById('editUserStatus').value = user.status || 'Active';
            
            // Load groups for dropdown
            const groupSelect = document.getElementById('editUserGroup');
            groupSelect.innerHTML = '<option value="">No Group</option>';
            
            const groupsSnapshot = await get(ref(database, 'groups'));
            
            if (groupsSnapshot.exists()) {
                const groupsData = groupsSnapshot.val();
                
                for (const groupId in groupsData) {
                    const option = document.createElement('option');
                    option.value = groupId;
                    option.textContent = groupsData[groupId].name;
                    
                    if (user.groupId === groupId) {
                        option.selected = true;
                    }
                    
                    groupSelect.appendChild(option);
                }
            }
            
            document.getElementById('editUserModal').classList.remove('hidden');
        }

        async function saveUserChanges() {
            const userId = document.getElementById('editUserId').value;
            const fullName = document.getElementById('editUserName').value.trim();
            const admissionNumber = document.getElementById('editUserAdmissionNumber').value.trim();
            const email = document.getElementById('editUserEmail').value.trim();
            const phoneNumber = document.getElementById('editUserPhone').value.trim();
            const status = document.getElementById('editUserStatus').value;
            const groupId = document.getElementById('editUserGroup').value;
            
            if (!fullName || !admissionNumber || !email) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            showLoading('Saving changes...');
            
            try {
                // Get current user data
                const userSnapshot = await get(ref(database, `users/${userId}`));
                
                if (!userSnapshot.exists()) {
                    throw new Error('User not found');
                }
                
                const userData = userSnapshot.val();
                const oldGroupId = userData.groupId;
                const hasJoinedGroup = !!groupId;
                
                // Handle group changes
                if (oldGroupId !== groupId) {
                    // Remove from old group
                    if (oldGroupId) {
                        // Update old group member count
                        const oldGroupSnapshot = await get(ref(database, `groups/${oldGroupId}`));
                        
                        if (oldGroupSnapshot.exists()) {
                            const oldGroupData = oldGroupSnapshot.val();
                            
                            await update(ref(database, `groups/${oldGroupId}`), {
                                memberCount: Math.max(0, (oldGroupData.memberCount || 0) - 1)
                            });
                        }
                        
                        // Remove user from old group members
                        await remove(ref(database, `groupMembers/${oldGroupId}/${userId}`));
                    }
                    
                    // Add to new group
                    if (groupId) {
                        // Update new group member count
                        const newGroupSnapshot = await get(ref(database, `groups/${groupId}`));
                        
                        if (newGroupSnapshot.exists()) {
                            const newGroupData = newGroupSnapshot.val();
                            
                            await update(ref(database, `groups/${groupId}`), {
                                memberCount: (newGroupData.memberCount || 0) + 1
                            });
                        }
                        
                        // Add user to new group members
                        await set(ref(database, `groupMembers/${groupId}/${userId}`), {
                            userId,
                            fullName,
                            admissionNumber,
                            email,
                            phoneNumber,
                            joinedAt: serverTimestamp()
                        });
                    }
                }
                
                // Update user data
                await update(ref(database, `users/${userId}`), {
                    fullName,
                    admissionNumber,
                    email,
                    phoneNumber,
                    status,
                    groupId,
                    hasJoinedGroup
                });
                
                // Update admission number reference if changed
                if (admissionNumber !== userData.admissionNumber) {
                    await remove(ref(database, `userAdmissionNumbers/${userData.admissionNumber}`));
                    await set(ref(database, `userAdmissionNumbers/${admissionNumber}`), userId);
                }
                
                hideLoading();
                showToast('User updated successfully', 'success');
                
                // Close modal
                document.getElementById('editUserModal').classList.add('hidden');
                
                // Reload users
                loadUsers();
            } catch (error) {
                hideLoading();
                console.error("Error updating user:", error);
                showToast('Failed to update user', 'error');
            }
        }

        async function deleteUser() {
            const userId = document.getElementById('editUserId').value;
            
            if (!confirm('Are you sure you want to delete this user?')) {
                return;
            }
            
            showLoading('Deleting user...');
            
            try {
                // Get user data
                const userSnapshot = await get(ref(database, `users/${userId}`));
                
                if (!userSnapshot.exists()) {
                    throw new Error('User not found');
                }
                
                const userData = userSnapshot.val();
                
                // Remove from group if in one
                if (userData.groupId) {
                    // Update group member count
                    const groupSnapshot = await get(ref(database, `groups/${userData.groupId}`));
                    
                    if (groupSnapshot.exists()) {
                        const groupData = groupSnapshot.val();
                        
                        await update(ref(database, `groups/${userData.groupId}`), {
                            memberCount: Math.max(0, (groupData.memberCount || 0) - 1)
                        });
                    }
                    
                    // Remove user from group members
                    await remove(ref(database, `groupMembers/${userData.groupId}/${userId}`));
                }
                
                // Remove admission number reference
                await remove(ref(database, `userAdmissionNumbers/${userData.admissionNumber}`));
                
                // Remove user data
                await remove(ref(database, `users/${userId}`));
                
                // Note: This doesn't delete the actual Firebase Auth user
                // In a production app, you would use Firebase Admin SDK to delete the auth user
                
                hideLoading();
                showToast('User deleted successfully', 'success');
                
                // Close modal
                document.getElementById('editUserModal').classList.add('hidden');
                
                // Reload users
                loadUsers();
            } catch (error) {
                hideLoading();
                console.error("Error deleting user:", error);
                showToast('Failed to delete user', 'error');
            }
        }

        async function loadAdminGroups() {
            try {
                showLoading('Loading groups...');
                
                const groupsSnapshot = await get(ref(database, 'groups'));
                userGroups = [];
                
                if (groupsSnapshot.exists()) {
                    const groupsData = groupsSnapshot.val();
                    
                    for (const groupId in groupsData) {
                        userGroups.push({
                            id: groupId,
                            ...groupsData[groupId]
                        });
                    }
                    
                    renderAdminGroups();
                } else {
                    adminGroupsContainer.innerHTML = '<p class="col-span-full text-center text-gray-500 dark:text-gray-400">No groups found</p>';
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error("Error loading groups:", error);
                showToast('Failed to load groups', 'error');
            }
        }

        function renderAdminGroups() {
            adminGroupsContainer.innerHTML = '';
            
            userGroups.forEach(group => {
                const groupCard = document.createElement('div');
                groupCard.className = 'bg-white dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg shadow-sm p-4';
                
                const groupHeader = document.createElement('div');
                groupHeader.className = 'flex justify-between items-center mb-2';
                
                const groupName = document.createElement('h3');
                groupName.className = 'font-medium';
                groupName.textContent = group.name;
                
                const groupCapacity = document.createElement('span');
                groupCapacity.className = 'px-2 py-1 rounded-full text-xs font-medium';
                
                if (group.memberCount >= group.capacity) {
                    groupCapacity.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-700', 'dark:text-red-100');
                } else {
                    groupCapacity.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-700', 'dark:text-green-100');
                }
                
                groupCapacity.textContent = `${group.memberCount}/${group.capacity}`;
                
                groupHeader.appendChild(groupName);
                groupHeader.appendChild(groupCapacity);
                
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'flex justify-between gap-2 mt-2';
                
                const viewBtn = document.createElement('button');
                viewBtn.className = 'flex-1 bg-primary hover:bg-secondary text-white py-2 rounded-lg transition-colors';
                viewBtn.textContent = 'View Members';
                viewBtn.onclick = () => openViewGroupModal(group);
                
                const editBtn = document.createElement('button');
                editBtn.className = 'flex-1 border border-primary text-primary hover:bg-primary hover:text-white py-2 rounded-lg transition-colors';
                editBtn.textContent = 'Edit Group';
                editBtn.onclick = () => openEditGroupModal(group);
                
                buttonsDiv.appendChild(viewBtn);
                buttonsDiv.appendChild(editBtn);
                
                groupCard.appendChild(groupHeader);
                groupCard.appendChild(buttonsDiv);
                
                adminGroupsContainer.appendChild(groupCard);
            });
        }

        function openCreateGroupModal() {
            document.getElementById('groupModalTitle').textContent = 'Create Group';
            document.getElementById('editGroupId').value = '';
            document.getElementById('groupName').value = '';
            document.getElementById('groupCapacity').value = '11';
            document.getElementById('chatEnabled').checked = true;
            document.getElementById('deleteGroupBtn').classList.add('hidden');
            
            document.getElementById('groupModal').classList.remove('hidden');
        }

        function openEditGroupModal(group) {
            document.getElementById('groupModalTitle').textContent = 'Edit Group';
            document.getElementById('editGroupId').value = group.id;
            document.getElementById('groupName').value = group.name;
            document.getElementById('groupCapacity').value = group.capacity;
            document.getElementById('chatEnabled').checked = group.chatEnabled !== false;
            document.getElementById('deleteGroupBtn').classList.remove('hidden');
            
            document.getElementById('groupModal').classList.remove('hidden');
        }

        async function saveGroup() {
            const groupId = document.getElementById('editGroupId').value;
            const name = document.getElementById('groupName').value.trim();
            const capacity = parseInt(document.getElementById('groupCapacity').value);
            const chatEnabled = document.getElementById('chatEnabled').checked;
            
            if (!name) {
                showToast('Please enter a group name', 'error');
                return;
            }
            
            if (isNaN(capacity) || capacity < 1) {
                showToast('Please enter a valid capacity', 'error');
                return;
            }
            
            showLoading(groupId ? 'Updating group...' : 'Creating group...');
            
            try {
                if (groupId) {
                    // Get current group data
                    const groupSnapshot = await get(ref(database, `groups/${groupId}`));
                    
                    if (!groupSnapshot.exists()) {
                        throw new Error('Group not found');
                    }
                    
                    const groupData = groupSnapshot.val();
                    
                    // Update group
                    await update(ref(database, `groups/${groupId}`), {
                        name,
                        capacity,
                        chatEnabled
                    });
                    
                    hideLoading();
                    showToast('Group updated successfully', 'success');
                } else {
                    // Create new group
                    const groupRef = push(ref(database, 'groups'));
                    
                    await set(groupRef, {
                        name,
                        capacity,
                        memberCount: 0,
                        chatEnabled,
                        createdAt: serverTimestamp()
                    });
                    
                    hideLoading();
                    showToast('Group created successfully', 'success');
                }
                
                // Close modal
                document.getElementById('groupModal').classList.add('hidden');
                
                // Reload groups
                loadAdminGroups();
            } catch (error) {
                hideLoading();
                console.error("Error saving group:", error);
                showToast('Failed to save group', 'error');
            }
        }

        async function deleteGroup() {
            const groupId = document.getElementById('editGroupId').value;
            
            if (!confirm('Are you sure you want to delete this group?')) {
                return;
            }
            
            showLoading('Deleting group...');
            
            try {
                // Get group data
                const groupSnapshot = await get(ref(database, `groups/${groupId}`));
                
                if (!groupSnapshot.exists()) {
                    throw new Error('Group not found');
                }
                
                const groupData = groupSnapshot.val();
                
                // Check if group has members
                if (groupData.memberCount > 0) {
                    // Get group members
                    const membersSnapshot = await get(ref(database, `groupMembers/${groupId}`));
                    
                    if (membersSnapshot.exists()) {
                        const membersData = membersSnapshot.val();
                        
                        // Update each member
                        for (const memberId in membersData) {
                            await update(ref(database, `users/${memberId}`), {
                                groupId: null,
                                hasJoinedGroup: false
                            });
                        }
                    }
                    
                    // Delete group members
                    await remove(ref(database, `groupMembers/${groupId}`));
                }
                
                // Delete group chat
                await remove(ref(database, `groupChats/${groupId}`));
                
                // Delete group
                await remove(ref(database, `groups/${groupId}`));
                
                hideLoading();
                showToast('Group deleted successfully', 'success');
                
                // Close modal
                document.getElementById('groupModal').classList.add('hidden');
                
                // Reload groups
                loadAdminGroups();
            } catch (error) {
                hideLoading();
                console.error("Error deleting group:", error);
                showToast('Failed to delete group', 'error');
            }
        }

        async function openViewGroupModal(group) {
            document.getElementById('viewGroupName').textContent = group.name;
            document.getElementById('viewGroupMembersCount').textContent = group.memberCount || 0;
            document.getElementById('viewGroupCapacity').textContent = group.capacity;
            document.getElementById('editGroupBtn').onclick = () => {
                document.getElementById('viewGroupModal').classList.add('hidden');
                openEditGroupModal(group);
            };
            
            // Load group members
            const membersTableBody = document.getElementById('viewGroupMembersTable');
            membersTableBody.innerHTML = '';
            
            try {
                const membersSnapshot = await get(ref(database, `groupMembers/${group.id}`));
                
                if (membersSnapshot.exists()) {
                    const membersData = membersSnapshot.val();
                    
                    for (const memberId in membersData) {
                        const member = membersData[memberId];
                        
                        const tr = document.createElement('tr');
                        
                        const nameTd = document.createElement('td');
                        nameTd.className = 'px-4 py-2';
                        nameTd.textContent = member.fullName;
                        
                        const admissionTd = document.createElement('td');
                        admissionTd.className = 'px-4 py-2';
                        admissionTd.textContent = member.admissionNumber;
                        
                        const emailTd = document.createElement('td');
                        emailTd.className = 'px-4 py-2';
                        emailTd.textContent = member.email;
                        
                        const phoneTd = document.createElement('td');
                        phoneTd.className = 'px-4 py-2';
                        phoneTd.textContent = member.phoneNumber || '-';
                        
                        const actionsTd = document.createElement('td');
                        actionsTd.className = 'px-4 py-2';
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'text-red-600 hover:text-red-800';
                        removeBtn.innerHTML = '<i class="fas fa-user-minus"></i>';
                        removeBtn.title = 'Remove from group';
                        removeBtn.onclick = () => removeUserFromGroup(memberId, group.id);
                        
                        actionsTd.appendChild(removeBtn);
                        
                        tr.appendChild(nameTd);
                        tr.appendChild(admissionTd);
                        tr.appendChild(emailTd);
                        tr.appendChild(phoneTd);
                        tr.appendChild(actionsTd);
                        
                        membersTableBody.appendChild(tr);
                    }
                } else {
                    membersTableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center">No members in this group</td></tr>';
                }
                
                document.getElementById('viewGroupModal').classList.remove('hidden');
            } catch (error) {
                console.error("Error loading group members:", error);
                showToast('Failed to load group members', 'error');
            }
        }

        async function removeUserFromGroup(userId, groupId) {
            if (!confirm('Are you sure you want to remove this user from the group?')) {
                return;
            }
            
            showLoading('Removing user from group...');
            
            try {
                // Update group member count
                const groupSnapshot = await get(ref(database, `groups/${groupId}`));
                
                if (groupSnapshot.exists()) {
                    const groupData = groupSnapshot.val();
                    
                    await update(ref(database, `groups/${groupId}`), {
                        memberCount: Math.max(0, (groupData.memberCount || 0) - 1)
                    });
                }
                
                // Remove user from group members
                await remove(ref(database, `groupMembers/${groupId}/${userId}`));
                
                // Update user data
                await update(ref(database, `users/${userId}`), {
                    groupId: null,
                    hasJoinedGroup: false
                });
                
                hideLoading();
                showToast('User removed from group successfully', 'success');
                
                // Reload group members
                openViewGroupModal({
                    id: groupId,
                    name: document.getElementById('viewGroupName').textContent,
                    capacity: document.getElementById('viewGroupCapacity').textContent,
                    memberCount: parseInt(document.getElementById('viewGroupMembersCount').textContent) - 1
                });
            } catch (error) {
                hideLoading();
                console.error("Error removing user from group:", error);
                showToast('Failed to remove user from group', 'error');
            }
        }

        async function exportUsers() {
            try {
                showLoading('Preparing export...');
                
                // Load all users
                const usersSnapshot = await get(ref(database, 'users'));
                const users = [];
                
                if (usersSnapshot.exists()) {
                    const usersData = usersSnapshot.val();
                    
                    // Get groups for reference
                    const groupsSnapshot = await get(ref(database, 'groups'));
                    const groups = {};
                    
                    if (groupsSnapshot.exists()) {
                        const groupsData = groupsSnapshot.val();
                        
                        for (const groupId in groupsData) {
                            groups[groupId] = groupsData[groupId].name;
                        }
                    }
                    
                    // Format user data
                    for (const userId in usersData) {
                        const user = usersData[userId];
                        
                        users.push({
                            'Full Name': user.fullName,
                            'Admission Number': user.admissionNumber,
                            'Email': user.email,
                            'Phone Number': user.phoneNumber || '',
                            'Group': user.groupId ? groups[user.groupId] || '' : '',
                            'Status': user.status || 'Active',
                            'Last Login': formatDate(user.lastLogin)
                        });
                    }
                    
                    // Generate CSV
                    const headers = Object.keys(users[0]);
                    let csv = headers.join(',') + '\n';
                    
                    users.forEach(user => {
                        const row = headers.map(header => {
                            const value = user[header] || '';
                            // Escape commas and quotes
                            return `"${value.toString().replace(/"/g, '""')}"`;
                        });
                        
                        csv += row.join(',') + '\n';
                    });
                    
                    hideLoading();
                    
                    // Display as text
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                    
                    const content = document.createElement('div');
                    content.className = 'bg-white dark:bg-dark-card p-6 rounded-lg shadow-lg w-full max-w-4xl max-h-[80vh] flex flex-col';
                    
                    const header = document.createElement('div');
                    header.className = 'flex justify-between items-center mb-4';
                    
                    const title = document.createElement('h2');
                    title.className = 'text-xl font-semibold';
                    title.textContent = 'Users Export';
                    
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200';
                    closeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    closeBtn.onclick = () => document.body.removeChild(modal);
                    
                    header.appendChild(title);
                    header.appendChild(closeBtn);
                    
                    const textarea = document.createElement('textarea');
                    textarea.className = 'w-full flex-1 border border-light-border dark:border-dark-border rounded-lg p-4 bg-light-bg dark:bg-dark-bg font-mono text-sm overflow-auto';
                    textarea.value = csv;
                    textarea.readOnly = true;
                    
                    const instructions = document.createElement('div');
                    instructions.className = 'mt-4 text-sm text-gray-600 dark:text-gray-400';
                    instructions.innerHTML = '<p>Please copy this CSV data and paste it into a text file with a .csv extension, then open it with Excel or another spreadsheet application.</p>';
                    
                    content.appendChild(header);
                    content.appendChild(textarea);
                    content.appendChild(instructions);
                    
                    modal.appendChild(content);
                    document.body.appendChild(modal);
                    
                    // Select all text for easy copying
                    textarea.select();
                }
            } catch (error) {
                hideLoading();
                console.error("Error exporting users:", error);
                showToast('Failed to export users', 'error');
            }
        }

        async function exportAllGroups() {
            try {
                showLoading('Preparing export...');
                
                // Load all groups
                const groupsSnapshot = await get(ref(database, 'groups'));
                
                if (!groupsSnapshot.exists()) {
                    hideLoading();
                    showToast('No groups to export', 'info');
                    return;
                }
                
                const groupsData = groupsSnapshot.val();
                const groupsWithMembers = {};
                
                // Load members for each group
                for (const groupId in groupsData) {
                    const group = groupsData[groupId];
                    
                    const membersSnapshot = await get(ref(database, `groupMembers/${groupId}`));
                    const members = [];
                    
                    if (membersSnapshot.exists()) {
                        const membersData = membersSnapshot.val();
                        
                        for (const memberId in membersData) {
                            const member = membersData[memberId];
                            
                            members.push({
                                'Admission Number': member.admissionNumber,
                                'Name': member.fullName,
                                'Phone': member.phoneNumber || ''
                            });
                        }
                    }
                    
                    groupsWithMembers[group.name] = members;
                }
                
                // Generate CSV for each group
                let csv = '';
                
                for (const groupName in groupsWithMembers) {
                    const members = groupsWithMembers[groupName];
                    
                    csv += `Group: ${groupName}\n`;
                    
                    if (members.length > 0) {
                        const headers = Object.keys(members[0]);
                        csv += headers.join(',') + '\n';
                        
                        members.forEach(member => {
                            const row = headers.map(header => {
                                const value = member[header] || '';
                                // Escape commas and quotes
                                return `"${value.toString().replace(/"/g, '""')}"`;
                            });
                            
                            csv += row.join(',') + '\n';
                        });
                    } else {
                        csv += 'No members\n';
                    }
                    
                    csv += '\n\n';
                }
                
                hideLoading();
                
                // Display as text
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                
                const content = document.createElement('div');
                content.className = 'bg-white dark:bg-dark-card p-6 rounded-lg shadow-lg w-full max-w-4xl max-h-[80vh] flex flex-col';
                
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center mb-4';
                
                const title = document.createElement('h2');
                title.className = 'text-xl font-semibold';
                title.textContent = 'Groups Export';
                
                const closeBtn = document.createElement('button');
                closeBtn.className = 'text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200';
                closeBtn.innerHTML = '<i class="fas fa-times"></i>';
                closeBtn.onclick = () => document.body.removeChild(modal);
                
                header.appendChild(title);
                header.appendChild(closeBtn);
                
                const textarea = document.createElement('textarea');
                textarea.className = 'w-full flex-1 border border-light-border dark:border-dark-border rounded-lg p-4 bg-light-bg dark:bg-dark-bg font-mono text-sm overflow-auto';
                textarea.value = csv;
                textarea.readOnly = true;
                
                const instructions = document.createElement('div');
                instructions.className = 'mt-4 text-sm text-gray-600 dark:text-gray-400';
                instructions.innerHTML = '<p>Please copy this CSV data and paste it into a text file with a .csv extension, then open it with Excel or another spreadsheet application.</p>';
                
                content.appendChild(header);
                content.appendChild(textarea);
                content.appendChild(instructions);
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Select all text for easy copying
                textarea.select();
            } catch (error) {
                hideLoading();
                console.error("Error exporting groups:", error);
                showToast('Failed to export groups', 'error');
            }
        }

        // Event listeners
        // Auth forms
        document.getElementById('showRegisterBtn').addEventListener('click', () => showAuthForm('register'));
        document.getElementById('showLoginBtn').addEventListener('click', () => showAuthForm('login'));
        document.getElementById('forgotPasswordBtn').addEventListener('click', () => showAuthForm('forgotPassword'));
        document.getElementById('backToLoginBtn').addEventListener('click', () => showAuthForm('login'));
        document.getElementById('verificationBackToLoginBtn').addEventListener('click', () => showAuthForm('login'));
        
        document.getElementById('loginBtn').addEventListener('click', loginUser);
        document.getElementById('registerBtn').addEventListener('click', registerUser);
        document.getElementById('resetPasswordBtn').addEventListener('click', resetPassword);
        document.getElementById('resendVerificationBtn').addEventListener('click', resendVerificationEmail);
        
        // Enter key for forms
        document.getElementById('loginEmail').addEventListener('keydown', e => {
            if (e.key === 'Enter') document.getElementById('loginPassword').focus();
        });
        document.getElementById('loginPassword').addEventListener('keydown', e => {
            if (e.key === 'Enter') loginUser();
        });
        
        // User dashboard
        document.getElementById('userMenuBtn').addEventListener('click', () => {
            document.getElementById('userMenu').classList.toggle('hidden');
        });
        
        document.getElementById('viewProfileBtn').addEventListener('click', () => {
            document.getElementById('userMenu').classList.add('hidden');
            userProfileSection.classList.remove('hidden');
            loadUserProfile();
        });
        
        document.getElementById('closeProfileBtn').addEventListener('click', () => {
            userProfileSection.classList.add('hidden');
        });
        
        document.getElementById('updateProfileBtn').addEventListener('click', updateUserProfile);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        
        // Admin dashboard
        document.getElementById('adminMenuBtn').addEventListener('click', () => {
            document.getElementById('adminMenu').classList.toggle('hidden');
        });
        
        document.getElementById('adminLogoutBtn').addEventListener('click', logout);
        
        document.getElementById('showUsersBtn').addEventListener('click', () => {
            userManagementSection.classList.remove('hidden');
            groupManagementSection.classList.add('hidden');
            exportDataSection.classList.add('hidden');
            loadUsers();
        });
        
        document.getElementById('showGroupsBtn').addEventListener('click', () => {
            userManagementSection.classList.add('hidden');
            groupManagementSection.classList.remove('hidden');
            exportDataSection.classList.add('hidden');
            loadAdminGroups();
        });
        
        document.getElementById('exportDataBtn').addEventListener('click', () => {
            userManagementSection.classList.add('hidden');
            groupManagementSection.classList.add('hidden');
            exportDataSection.classList.remove('hidden');
        });
        
        document.getElementById('exportUsersBtn').addEventListener('click', exportUsers);
        document.getElementById('exportAllGroupsBtn').addEventListener('click', exportAllGroups);
        
        // User management
        document.getElementById('closeEditUserModal').addEventListener('click', () => {
            document.getElementById('editUserModal').classList.add('hidden');
        });
        
        document.getElementById('saveUserChangesBtn').addEventListener('click', saveUserChanges);
        document.getElementById('deleteUserBtn').addEventListener('click', deleteUser);
        
        // Group management
        document.getElementById('createGroupBtn').addEventListener('click', openCreateGroupModal);
        
        document.getElementById('closeGroupModal').addEventListener('click', () => {
            document.getElementById('groupModal').classList.add('hidden');
        });
        
        document.getElementById('closeViewGroupModal').addEventListener('click', () => {
            document.getElementById('viewGroupModal').classList.add('hidden');
        });
        
        document.getElementById('saveGroupBtn').addEventListener('click', saveGroup);
        document.getElementById('deleteGroupBtn').addEventListener('click', deleteGroup);
        
        // Click outside to close dropdowns
        document.addEventListener('click', (e) => {
            // User menu
            if (!e.target.closest('#userMenuBtn') && !e.target.closest('#userMenu')) {
                document.getElementById('userMenu').classList.add('hidden');
            }
            
            // Admin menu
            if (!e.target.closest('#adminMenuBtn') && !e.target.closest('#adminMenu')) {
                document.getElementById('adminMenu').classList.add('hidden');
            }
        });
        
        // Initial auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                
                try {
                    // Get user data
                    const userSnapshot = await get(ref(database, `users/${user.uid}`));
                    
                    if (userSnapshot.exists()) {
                        currentUserData = userSnapshot.val();
                        currentUserRole = currentUserData.role;
                        
                        // Check if email is verified
                        if (!user.emailVerified) {
                            await signOut(auth);
                            showAuthForm('emailVerification');
                            return;
                        }
                        
                        // Show appropriate dashboard
                        if (currentUserRole === 'admin') {
                            showAdminDashboard();
                        } else {
                            showUserDashboard();
                        }
                    } else {
                        // User exists in Auth but not in database
                        console.error("User not found in database");
                        await signOut(auth);
                        showAuthForm('login');
                    }
                } catch (error) {
                    console.error("Error fetching user data:", error);
                    await signOut(auth);
                    showAuthForm('login');
                }
            } else {
                // No user is signed in
                currentUser = null;
                currentUserData = null;
                currentUserRole = null;
                showAuthForm('login');
            }
        });
    </script>
</body>
</html>