<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#4B4ABA',
                        dark: {
                            bg: '#181818',
                            card: '#272727',
                            text: '#E0E0E0'
                        },
                        light: {
                            bg: '#FFFFFF',
                            card: '#F5F5F7',
                            text: '#333333'
                        }
                    }
                }
            }
        }
    </script>
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendEmailVerification, sendPasswordResetEmail, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";
        import { getDatabase, ref, set, get, update, remove, onValue, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB-a01V6F-tyS5xhgUEflbnnDcp4BROJUU",
            authDomain: "fortunelabse.firebaseapp.com",
            databaseURL: "https://fortunelabse-default-rtdb.firebaseio.com",
            projectId: "fortunelabse",
            storageBucket: "fortunelabse.firebasestorage.app",
            messagingSenderId: "853842400913",
            appId: "1:853842400913:web:12ee9519c8667fa83d5130",
            measurementId: "G-XYV95HGG1G"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const firestore = getFirestore(app);

        // Make Firebase services available globally
        window.app = app;
        window.auth = auth;
        window.db = db;
        window.firestore = firestore;
        window.firebase = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            sendEmailVerification,
            sendPasswordResetEmail,
            onAuthStateChanged,
            updateProfile,
            db: {
                ref, set, get, update, remove, onValue, push, serverTimestamp
            },
            firestore: {
                collection, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs, query, where, orderBy
            }
        };
    </script>
</head>
<body class="bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text min-h-screen transition-colors duration-200">
    <!-- App Container -->
    <div id="app" class="flex flex-col min-h-screen">
        <!-- Navigation Bar -->
        <nav id="navbar" class="hidden bg-white dark:bg-dark-card shadow-md px-4 py-3">
            <div class="container mx-auto flex justify-between items-center">
                <div class="text-xl font-bold text-primary">Group Management System</div>
                <div id="nav-menu" class="hidden md:flex space-x-4"></div>
                <button id="mobile-menu-btn" class="md:hidden p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
            <div id="mobile-menu" class="hidden md:hidden mt-2 py-2 space-y-2"></div>
        </nav>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-grow container mx-auto px-4 py-6">
            <!-- Pages will be loaded here -->
            
            <!-- Auth Pages -->
            <div id="auth-pages">
                <!-- Login Page -->
                <div id="login-page" class="flex justify-center items-center min-h-[80vh]">
                    <div class="bg-white dark:bg-dark-card shadow-md rounded-lg p-8 w-full max-w-md">
                        <h2 class="text-2xl font-bold text-center mb-6">Login</h2>
                        <form id="login-form" class="space-y-4">
                            <div>
                                <label for="login-email" class="block text-sm font-medium mb-1">Email or Admission Number</label>
                                <input type="text" id="login-email" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white" required>
                            </div>
                            <div>
                                <label for="login-password" class="block text-sm font-medium mb-1">Password</label>
                                <input type="password" id="login-password" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white" required>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <input type="checkbox" id="remember-me" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                                    <label for="remember-me" class="ml-2 block text-sm">Remember me</label>
                                </div>
                                <div class="text-sm">
                                    <a href="#" id="forgot-password-link" class="text-primary hover:underline">Forgot password?</a>
                                </div>
                            </div>
                            <div>
                                <button type="submit" class="w-full py-2 px-4 bg-primary hover:bg-secondary text-white font-semibold rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                                    Sign in
                                </button>
                            </div>
                            <p id="login-error" class="text-red-500 text-sm hidden"></p>
                        </form>
                        <div class="mt-4 text-center">
                            <p class="text-sm">Don't have an account? <a href="#" id="register-link" class="text-primary hover:underline">Register</a></p>
                        </div>
                    </div>
                </div>

                <!-- Registration Page -->
                <div id="register-page" class="hidden flex justify-center items-center min-h-[80vh]">
                    <div class="bg-white dark:bg-dark-card shadow-md rounded-lg p-8 w-full max-w-md">
                        <h2 class="text-2xl font-bold text-center mb-6">Create Account</h2>
                        <form id="register-form" class="space-y-4">
                            <div>
                                <label for="register-name" class="block text-sm font-medium mb-1">Full Name</label>
                                <input type="text" id="register-name" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white" required>
                            </div>
                            <div>
                                <label for="register-admission" class="block text-sm font-medium mb-1">Admission Number</label>
                                <input type="text" id="register-admission" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white" required>
                            </div>
                            <div>
                                <label for="register-email" class="block text-sm font-medium mb-1">Email</label>
                                <input type="email" id="register-email" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white" required>
                            </div>
                            <div>
                                <label for="register-phone" class="block text-sm font-medium mb-1">Phone Number</label>
                                <input type="tel" id="register-phone" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white" required>
                            </div>
                            <div>
                                <label for="register-password" class="block text-sm font-medium mb-1">Password</label>
                                <input type="password" id="register-password" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white" required
                                    minlength="6" pattern=".{6,}" title="Password must be at least 6 characters">
                                <p class="text-xs text-gray-500 mt-1">Minimum 6 characters</p>
                            </div>
                            <div>
                                <button type="submit" class="w-full py-2 px-4 bg-primary hover:bg-secondary text-white font-semibold rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                                    Register
                                </button>
                            </div>
                            <p id="register-error" class="text-red-500 text-sm hidden"></p>
                        </form>
                        <div class="mt-4 text-center">
                            <p class="text-sm">Already have an account? <a href="#" id="login-link" class="text-primary hover:underline">Sign in</a></p>
                        </div>
                    </div>
                </div>

                <!-- Forgot Password Page -->
                <div id="forgot-password-page" class="hidden flex justify-center items-center min-h-[80vh]">
                    <div class="bg-white dark:bg-dark-card shadow-md rounded-lg p-8 w-full max-w-md">
                        <h2 class="text-2xl font-bold text-center mb-6">Reset Password</h2>
                        <form id="forgot-password-form" class="space-y-4">
                            <div>
                                <label for="reset-email" class="block text-sm font-medium mb-1">Email</label>
                                <input type="email" id="reset-email" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white" required>
                            </div>
                            <div>
                                <button type="submit" class="w-full py-2 px-4 bg-primary hover:bg-secondary text-white font-semibold rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                                    Send Reset Link
                                </button>
                            </div>
                            <p id="reset-message" class="text-sm text-center hidden"></p>
                        </form>
                        <div class="mt-4 text-center">
                            <p class="text-sm"><a href="#" id="back-to-login" class="text-primary hover:underline">Back to Login</a></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Dashboard -->
            <div id="user-dashboard" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- Sidebar -->
                    <div class="md:col-span-1 bg-white dark:bg-dark-card rounded-lg shadow-md p-4">
                        <div class="flex flex-col space-y-4">
                            <div class="p-4 text-center">
                                <div class="w-24 h-24 mx-auto bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center text-2xl font-bold text-primary mb-2">
                                    <span id="user-initials">JD</span>
                                </div>
                                <h3 id="user-name" class="text-xl font-semibold">John Doe</h3>
                                <p id="user-email" class="text-sm text-gray-500 dark:text-gray-400">john@example.com</p>
                            </div>
                            <hr class="border-gray-200 dark:border-gray-700">
                            <button id="profile-btn" class="py-2 px-4 rounded-md text-left hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                                </svg>
                                Profile
                            </button>
                            <button id="groups-btn" class="py-2 px-4 rounded-md text-left hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />
                                </svg>
                                Groups
                            </button>
                            <button id="chat-btn" class="py-2 px-4 rounded-md text-left hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
                                </svg>
                                Group Chat
                            </button>
                            <hr class="border-gray-200 dark:border-gray-700">
                            <button id="user-logout-btn" class="py-2 px-4 rounded-md text-left text-red-500 hover:bg-red-50 dark:hover:bg-red-900 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 001 1h12a1 1 0 001-1V4a1 1 0 00-1-1H3zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
                                </svg>
                                Logout
                            </button>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="md:col-span-3 space-y-6">
                        <!-- User Profile Section -->
                        <div id="user-profile-section" class="bg-white dark:bg-dark-card rounded-lg shadow-md p-6">
                            <h2 class="text-xl font-semibold mb-4">My Profile</h2>
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Full Name</label>
                                        <p id="profile-name" class="py-2 px-3 bg-gray-100 dark:bg-gray-700 rounded-md">John Doe</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Admission Number</label>
                                        <p id="profile-admission" class="py-2 px-3 bg-gray-100 dark:bg-gray-700 rounded-md">AD12345</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Email</label>
                                        <p id="profile-email" class="py-2 px-3 bg-gray-100 dark:bg-gray-700 rounded-md">john@example.com</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Phone Number</label>
                                        <p id="profile-phone" class="py-2 px-3 bg-gray-100 dark:bg-gray-700 rounded-md">+1234567890</p>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Account Status</label>
                                    <div class="flex items-center">
                                        <span id="profile-status" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                            Active
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Last Login</label>
                                    <p id="profile-last-login" class="text-sm text-gray-500 dark:text-gray-400">2023-06-01 14:30</p>
                                </div>
                            </div>
                        </div>

                        <!-- Group Management Section -->
                        <div id="user-groups-section" class="hidden bg-white dark:bg-dark-card rounded-lg shadow-md p-6">
                            <h2 class="text-xl font-semibold mb-4">Groups</h2>
                            <div class="mb-6">
                                <h3 class="text-lg font-medium mb-2">Current Group</h3>
                                <div id="current-group" class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                                    <p id="no-group-message" class="text-gray-500 dark:text-gray-400">You are not currently in any group.</p>
                                    <div id="current-group-details" class="hidden">
                                        <h4 id="current-group-name" class="text-lg font-semibold"></h4>
                                        <p id="current-group-description" class="text-sm text-gray-500 dark:text-gray-400 mt-1"></p>
                                        <div class="mt-3">
                                            <h5 class="text-sm font-medium mb-1">Members</h5>
                                            <div id="current-group-members" class="text-sm"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium mb-2">Available Groups</h3>
                                <div id="available-groups" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <p id="loading-groups" class="text-gray-500 dark:text-gray-400">Loading available groups...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Group Chat Section -->
                        <div id="user-chat-section" class="hidden bg-white dark:bg-dark-card rounded-lg shadow-md p-6 flex flex-col h-[600px]">
                            <h2 class="text-xl font-semibold mb-4">Group Chat</h2>
                            <div id="chat-container" class="flex-grow flex flex-col">
                                <div id="no-chat-group-message" class="flex-grow flex items-center justify-center">
                                    <p class="text-gray-500 dark:text-gray-400">You need to join a group to chat.</p>
                                </div>
                                <div id="chat-interface" class="hidden flex-grow flex flex-col">
                                    <div id="chat-messages" class="flex-grow overflow-y-auto mb-4 p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                                        <p class="text-center text-gray-500 dark:text-gray-400 text-sm my-2">Welcome to the group chat!</p>
                                    </div>
                                    <div class="flex">
                                        <input type="text" id="chat-input" class="flex-grow px-3 py-2 border rounded-l-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white" placeholder="Type your message...">
                                        <button id="send-message" class="px-4 py-2 bg-primary hover:bg-secondary text-white font-semibold rounded-r-md">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="admin-dashboard" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                    <!-- Sidebar -->
                    <div class="md:col-span-1 bg-white dark:bg-dark-card rounded-lg shadow-md p-4">
                        <div class="flex flex-col space-y-4">
                            <div class="p-4 text-center">
                                <div class="w-24 h-24 mx-auto bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center text-2xl font-bold text-primary mb-2">
                                    <span id="admin-initials">AD</span>
                                </div>
                                <h3 id="admin-name" class="text-xl font-semibold">Admin User</h3>
                                <p id="admin-email" class="text-sm text-gray-500 dark:text-gray-400">admin@example.com</p>
                                <div class="mt-2">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                        Administrator
                                    </span>
                                </div>
                            </div>
                            <hr class="border-gray-200 dark:border-gray-700">
                            <button id="admin-overview-btn" class="py-2 px-4 rounded-md text-left hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" />
                                    <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" />
                                </svg>
                                Dashboard
                            </button>
                            <button id="admin-users-btn" class="py-2 px-4 rounded-md text-left hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                                </svg>
                                Users
                            </button>
                            <button id="admin-groups-btn" class="py-2 px-4 rounded-md text-left hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />
                                </svg>
                                Groups
                            </button>
                            <button id="admin-export-btn" class="py-2 px-4 rounded-md text-left hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" />
                                </svg>
                                Export Data
                            </button>
                            <hr class="border-gray-200 dark:border-gray-700">
                            <button id="admin-logout-btn" class="py-2 px-4 rounded-md text-left text-red-500 hover:bg-red-50 dark:hover:bg-red-900 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 001 1h12a1 1 0 001-1V4a1 1 0 00-1-1H3zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
                                </svg>
                                Logout
                            </button>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="md:col-span-4 space-y-6">
                        <!-- Admin Overview Section -->
                        <div id="admin-overview-section" class="bg-white dark:bg-dark-card rounded-lg shadow-md p-6">
                            <h2 class="text-xl font-semibold mb-4">Dashboard Overview</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg">
                                    <h3 class="text-lg font-medium text-blue-700 dark:text-blue-300">Total Users</h3>
                                    <p id="total-users-count" class="text-2xl font-bold">0</p>
                                </div>
                                <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg">
                                    <h3 class="text-lg font-medium text-green-700 dark:text-green-300">Active Groups</h3>
                                    <p id="total-groups-count" class="text-2xl font-bold">0</p>
                                </div>
                                <div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg">
                                    <h3 class="text-lg font-medium text-purple-700 dark:text-purple-300">Users Without Group</h3>
                                    <p id="ungrouped-users-count" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium mb-3">Recent Activities</h3>
                                <div id="recent-activities" class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 max-h-60 overflow-y-auto">
                                    <p class="text-gray-500 dark:text-gray-400">No recent activities found.</p>
                                </div>
                            </div>
                        </div>

                        <!-- User Management Section -->
                        <div id="admin-users-section" class="hidden bg-white dark:bg-dark-card rounded-lg shadow-md p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold">User Management</h2>
                                <div class="flex space-x-2">
                                    <button id="export-users-btn" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded-md flex items-center text-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" />
                                        </svg>
                                        Export to Excel
                                    </button>
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="relative">
                                    <input type="text" id="user-search" class="w-full pl-10 pr-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white" placeholder="Search users...">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-2.5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                            </div>
                            <div class="overflow-x-auto border border-gray-200 dark:border-gray-700 rounded-lg">
                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                    <thead class="bg-gray-50 dark:bg-gray-800">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Admission Number</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Email</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Group</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body" class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                                        <tr>
                                            <td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Loading users...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Group Management Section -->
                        <div id="admin-groups-section" class="hidden bg-white dark:bg-dark-card rounded-lg shadow-md p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold">Group Management</h2>
                                <button id="create-group-btn" class="px-3 py-1 bg-primary hover:bg-secondary text-white rounded-md flex items-center text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                                    </svg>
                                    Create Group
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="admin-groups-list">
                                <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg animate-pulse">
                                    <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-2"></div>
                                    <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-1/2 mb-4"></div>
                                    <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-full mb-1"></div>
                                    <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-5/6"></div>
                                </div>
                                <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg animate-pulse">
                                    <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-2"></div>
                                    <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-1/2 mb-4"></div>
                                    <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-full mb-1"></div>
                                    <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-5/6"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Export Data Section -->
                        <div id="admin-export-section" class="hidden bg-white dark:bg-dark-card rounded-lg shadow-md p-6">
                            <h2 class="text-xl font-semibold mb-4">Export Data</h2>
                            <div>
                                <h3 class="text-lg font-medium mb-2">Export All Groups</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Export all groups data to an Excel file. The export will include group information and members.</p>
                                <button id="export-all-data-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-md shadow-sm flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" />
                                    </svg>
                                    Export All Groups to Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal Container -->
        <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div id="modal-content" class="bg-white dark:bg-dark-card rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                <div id="modal-header" class="flex justify-between items-center mb-4">
                    <h3 id="modal-title" class="text-xl font-semibold">Modal Title</h3>
                    <button id="modal-close" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="modal-body">
                    <!-- Modal content will be inserted here -->
                </div>
                <div id="modal-footer" class="mt-6 flex justify-end space-x-3">
                    <button id="modal-cancel" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-gray-800 focus:outline-none">
                        Cancel
                    </button>
                    <button id="modal-confirm" class="px-4 py-2 bg-primary hover:bg-secondary text-white rounded-md shadow-sm focus:outline-none">
                        Confirm
                    </button>
                </div>
            </div>
        </div>

        <!-- Notification Container -->
        <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2">
            <!-- Notifications will be appended here -->
        </div>
    </div>

    <!-- Application Scripts -->
    <script>
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        // Listen for changes in color scheme preference
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const navbar = document.getElementById('navbar');
            const navMenu = document.getElementById('nav-menu');
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            
            // Auth pages
            const authPages = document.getElementById('auth-pages');
            const loginPage = document.getElementById('login-page');
            const registerPage = document.getElementById('register-page');
            const forgotPasswordPage = document.getElementById('forgot-password-page');
            
            // Dashboards
            const userDashboard = document.getElementById('user-dashboard');
            const adminDashboard = document.getElementById('admin-dashboard');
            
            // User dashboard sections
            const userProfileSection = document.getElementById('user-profile-section');
            const userGroupsSection = document.getElementById('user-groups-section');
            const userChatSection = document.getElementById('user-chat-section');
            
            // Admin dashboard sections
            const adminOverviewSection = document.getElementById('admin-overview-section');
            const adminUsersSection = document.getElementById('admin-users-section');
            const adminGroupsSection = document.getElementById('admin-groups-section');
            const adminExportSection = document.getElementById('admin-export-section');
            
            // Modal elements
            const modalContainer = document.getElementById('modal-container');
            const modalContent = document.getElementById('modal-content');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalClose = document.getElementById('modal-close');
            const modalCancel = document.getElementById('modal-cancel');
            const modalConfirm = document.getElementById('modal-confirm');
            
            // Notification container
            const notificationContainer = document.getElementById('notification-container');

            // =====================
            // Auth Navigation Links
            // =====================
            document.getElementById('register-link').addEventListener('click', (e) => {
                e.preventDefault();
                loginPage.classList.add('hidden');
                registerPage.classList.remove('hidden');
                forgotPasswordPage.classList.add('hidden');
            });
            
            document.getElementById('login-link').addEventListener('click', (e) => {
                e.preventDefault();
                loginPage.classList.remove('hidden');
                registerPage.classList.add('hidden');
                forgotPasswordPage.classList.add('hidden');
            });
            
            document.getElementById('forgot-password-link').addEventListener('click', (e) => {
                e.preventDefault();
                loginPage.classList.add('hidden');
                registerPage.classList.add('hidden');
                forgotPasswordPage.classList.remove('hidden');
            });
            
            document.getElementById('back-to-login').addEventListener('click', (e) => {
                e.preventDefault();
                loginPage.classList.remove('hidden');
                registerPage.classList.add('hidden');
                forgotPasswordPage.classList.add('hidden');
            });

            // ==============================
            // Mobile Menu Toggle Functionality
            // ==============================
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });

            // =====================
            // User Dashboard Navigation
            // =====================
            document.getElementById('profile-btn').addEventListener('click', () => {
                userProfileSection.classList.remove('hidden');
                userGroupsSection.classList.add('hidden');
                userChatSection.classList.add('hidden');
            });
            
            document.getElementById('groups-btn').addEventListener('click', () => {
                userProfileSection.classList.add('hidden');
                userGroupsSection.classList.remove('hidden');
                userChatSection.classList.add('hidden');
            });
            
            document.getElementById('chat-btn').addEventListener('click', () => {
                userProfileSection.classList.add('hidden');
                userGroupsSection.classList.add('hidden');
                userChatSection.classList.remove('hidden');
            });

            // =====================
            // Admin Dashboard Navigation
            // =====================
            document.getElementById('admin-overview-btn').addEventListener('click', () => {
                adminOverviewSection.classList.remove('hidden');
                adminUsersSection.classList.add('hidden');
                adminGroupsSection.classList.add('hidden');
                adminExportSection.classList.add('hidden');
            });
            
            document.getElementById('admin-users-btn').addEventListener('click', () => {
                adminOverviewSection.classList.add('hidden');
                adminUsersSection.classList.remove('hidden');
                adminGroupsSection.classList.add('hidden');
                adminExportSection.classList.add('hidden');
            });
            
            document.getElementById('admin-groups-btn').addEventListener('click', () => {
                adminOverviewSection.classList.add('hidden');
                adminUsersSection.classList.add('hidden');
                adminGroupsSection.classList.remove('hidden');
                adminExportSection.classList.add('hidden');
            });
            
            document.getElementById('admin-export-btn').addEventListener('click', () => {
                adminOverviewSection.classList.add('hidden');
                adminUsersSection.classList.add('hidden');
                adminGroupsSection.classList.add('hidden');
                adminExportSection.classList.remove('hidden');
            });

            // =====================
            // Modal Functionality
            // =====================
            modalClose.addEventListener('click', () => {
                modalContainer.classList.add('hidden');
            });
            
            modalCancel.addEventListener('click', () => {
                modalContainer.classList.add('hidden');
            });
            
            // Close modal when clicking outside
            modalContainer.addEventListener('click', (e) => {
                if (e.target === modalContainer) {
                    modalContainer.classList.add('hidden');
                }
            });

            // Function to show modal
            window.showModal = function(title, content, confirmText = 'Confirm', cancelText = 'Cancel', onConfirm = null) {
                modalTitle.textContent = title;
                modalBody.innerHTML = content;
                modalConfirm.textContent = confirmText;
                modalCancel.textContent = cancelText;
                
                // Set up confirm button action
                if (onConfirm) {
                    modalConfirm.onclick = () => {
                        onConfirm();
                        modalContainer.classList.add('hidden');
                    };
                } else {
                    modalConfirm.onclick = () => {
                        modalContainer.classList.add('hidden');
                    };
                }
                
                modalContainer.classList.remove('hidden');
            };

            // =====================
            // Notification System
            // =====================
            window.showNotification = function(message, type = 'info', duration = 5000) {
                const notification = document.createElement('div');
                notification.className = `notification p-4 rounded-md shadow-md transition-all duration-300 opacity-0 transform translate-x-4`;
                
                // Set notification style based on type
                if (type === 'success') {
                    notification.classList.add('bg-green-500', 'text-white');
                } else if (type === 'error') {
                    notification.classList.add('bg-red-500', 'text-white');
                } else if (type === 'warning') {
                    notification.classList.add('bg-yellow-500', 'text-white');
                } else {
                    notification.classList.add('bg-blue-500', 'text-white');
                }
                
                notification.innerHTML = `
                    <div class="flex items-center">
                        <div class="flex-shrink-0 mr-2">
                            ${type === 'success' ? 
                                '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>' :
                                type === 'error' ?
                                '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>' :
                                type === 'warning' ?
                                '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>' :
                                '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>'
                            }
                        </div>
                        <p class="pr-6">${message}</p>
                        <button class="absolute top-2 right-2 text-white hover:text-gray-200 focus:outline-none" onclick="this.parentNode.parentNode.remove()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                
                notificationContainer.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.classList.remove('opacity-0', 'translate-x-4');
                }, 10);
                
                // Auto-remove after duration
                if (duration > 0) {
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.classList.add('opacity-0', 'translate-x-4');
                            setTimeout(() => {
                                if (notification.parentNode) {
                                    notification.remove();
                                }
                            }, 300);
                        }
                    }, duration);
                }
                
                return notification;
            };

            // =====================
            // Firebase Authentication
            // =====================
            
            // Register new user
            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const fullName = document.getElementById('register-name').value;
                const admissionNumber = document.getElementById('register-admission').value;
                const email = document.getElementById('register-email').value;
                const phone = document.getElementById('register-phone').value;
                const password = document.getElementById('register-password').value;
                const errorDisplay = document.getElementById('register-error');
                
                try {
                    errorDisplay.classList.add('hidden');
                    
                    // Create user in Firebase Auth
                    const userCredential = await window.firebase.createUserWithEmailAndPassword(window.auth, email, password);
                    const user = userCredential.user;
                    
                    // Update user profile with display name
                    await window.firebase.updateProfile(user, {
                        displayName: fullName
                    });
                    
                    // Send email verification
                    await window.firebase.sendEmailVerification(user);
                    
                    // Save additional user data to Firestore
                    const userData = {
                        fullName,
                        admissionNumber,
                        email,
                        phone,
                        isAdmin: email === 'cyntoremix@gmail.com', // Auto-assign admin role
                        status: 'Active',
                        createdAt: new Date().toISOString(),
                        lastLogin: new Date().toISOString(),
                        groupId: null
                    };
                    
                    await window.firebase.firestore.setDoc(window.firebase.firestore.doc(window.firestore, 'users', user.uid), userData);
                    
                    // Show success notification
                    window.showNotification('Registration successful! Please check your email for verification.', 'success');
                    
                    // Redirect to appropriate dashboard
                    if (email === 'cyntoremix@gmail.com') {
                        showAdminDashboard();
                    } else {
                        showUserDashboard();
                    }
                    
                } catch (error) {
                    console.error('Registration error:', error);
                    errorDisplay.textContent = error.message;
                    errorDisplay.classList.remove('hidden');
                }
            });
            
            // Login
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const emailOrAdmission = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const rememberMe = document.getElementById('remember-me').checked;
                const errorDisplay = document.getElementById('login-error');
                
                try {
                    errorDisplay.classList.add('hidden');
                    
                    // Check if input is email or admission number
                    let email = emailOrAdmission;
                    
                    // If it doesn't look like an email, try to find the user by admission number
                    if (!emailOrAdmission.includes('@')) {
                        // Query Firestore to find user by admission number
                        const q = window.firebase.firestore.query(
                            window.firebase.firestore.collection(window.firestore, 'users'),
                            window.firebase.firestore.where('admissionNumber', '==', emailOrAdmission)
                        );
                        
                        const querySnapshot = await window.firebase.firestore.getDocs(q);
                        
                        if (querySnapshot.empty) {
                            throw new Error('No user found with this admission number');
                        }
                        
                        // Get the email from the first matching user
                        email = querySnapshot.docs[0].data().email;
                    }
                    
                    // Set persistence based on remember me option
                    // Note: We can't use setPersistence in the sandbox, so this is just for show
                    // In a real app, you would use:
                    // await firebase.auth.setPersistence(rememberMe ? firebase.auth.browserSessionPersistence : firebase.auth.browserLocalPersistence);
                    
                    // Sign in user
                    const userCredential = await window.firebase.signInWithEmailAndPassword(window.auth, email, password);
                    const user = userCredential.user;
                    
                    // Update last login time
                    await window.firebase.firestore.updateDoc(window.firebase.firestore.doc(window.firestore, 'users', user.uid), {
                        lastLogin: new Date().toISOString()
                    });
                    
                    // Check user role
                    const userDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'users', user.uid));
                    const userData = userDoc.data();
                    
                    if (userData.isAdmin) {
                        // Show admin dashboard
                        showAdminDashboard();
                    } else {
                        // Show user dashboard
                        showUserDashboard();
                    }
                    
                    // Show success notification
                    window.showNotification('Login successful!', 'success');
                    
                } catch (error) {
                    console.error('Login error:', error);
                    errorDisplay.textContent = error.message;
                    errorDisplay.classList.remove('hidden');
                }
            });
            
            // Forgot Password
            document.getElementById('forgot-password-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('reset-email').value;
                const messageDisplay = document.getElementById('reset-message');
                
                try {
                    // Send password reset email
                    await window.firebase.sendPasswordResetEmail(window.auth, email);
                    
                    // Show success message
                    messageDisplay.textContent = 'Password reset link sent! Check your email.';
                    messageDisplay.classList.remove('hidden', 'text-red-500');
                    messageDisplay.classList.add('text-green-500');
                    
                } catch (error) {
                    console.error('Password reset error:', error);
                    messageDisplay.textContent = error.message;
                    messageDisplay.classList.remove('hidden', 'text-green-500');
                    messageDisplay.classList.add('text-red-500');
                }
            });
            
            // Logout functionality
            const logoutUser = async () => {
                try {
                    await window.firebase.signOut(window.auth);
                    showLoginPage();
                    window.showNotification('You have been logged out', 'info');
                } catch (error) {
                    console.error('Logout error:', error);
                    window.showNotification('Error logging out: ' + error.message, 'error');
                }
            };
            
            document.getElementById('user-logout-btn').addEventListener('click', logoutUser);
            document.getElementById('admin-logout-btn').addEventListener('click', logoutUser);

            // =====================
            // Navigation Functions
            // =====================
            
            // Show Login Page
            function showLoginPage() {
                navbar.classList.add('hidden');
                authPages.classList.remove('hidden');
                loginPage.classList.remove('hidden');
                registerPage.classList.add('hidden');
                forgotPasswordPage.classList.add('hidden');
                userDashboard.classList.add('hidden');
                adminDashboard.classList.add('hidden');
            }
            
            // Show User Dashboard
            function showUserDashboard() {
                navbar.classList.remove('hidden');
                authPages.classList.add('hidden');
                userDashboard.classList.remove('hidden');
                adminDashboard.classList.add('hidden');
                
                // Show profile section by default
                userProfileSection.classList.remove('hidden');
                userGroupsSection.classList.add('hidden');
                userChatSection.classList.add('hidden');
                
                // Load user data
                loadUserData();
                
                // Update navigation menu for user
                updateNavMenu('user');
            }
            
            // Show Admin Dashboard
            function showAdminDashboard() {
                navbar.classList.remove('hidden');
                authPages.classList.add('hidden');
                userDashboard.classList.add('hidden');
                adminDashboard.classList.remove('hidden');
                
                // Show overview section by default
                adminOverviewSection.classList.remove('hidden');
                adminUsersSection.classList.add('hidden');
                adminGroupsSection.classList.add('hidden');
                adminExportSection.classList.add('hidden');
                
                // Load admin dashboard data
                loadAdminDashboardData();
                
                // Update navigation menu for admin
                updateNavMenu('admin');
            }
            
            // Update Navigation Menu
            function updateNavMenu(userType) {
                // Clear current menu
                navMenu.innerHTML = '';
                mobileMenu.innerHTML = '';
                
                if (userType === 'user') {
                    // Desktop menu items for user
                    navMenu.innerHTML = `
                        <a href="#" class="text-gray-700 dark:text-gray-200 hover:text-primary dark:hover:text-primary">Dashboard</a>
                        <a href="#" class="text-gray-700 dark:text-gray-200 hover:text-primary dark:hover:text-primary">Groups</a>
                        <a href="#" class="text-gray-700 dark:text-gray-200 hover:text-primary dark:hover:text-primary">Chat</a>
                    `;
                    
                    // Mobile menu items for user
                    mobileMenu.innerHTML = `
                        <a href="#" class="block px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Dashboard</a>
                        <a href="#" class="block px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Groups</a>
                        <a href="#" class="block px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Chat</a>
                        <a href="#" id="mobile-logout" class="block px-4 py-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900">Logout</a>
                    `;
                    
                    // Add logout event listener to mobile menu
                    document.getElementById('mobile-logout').addEventListener('click', logoutUser);
                    
                } else if (userType === 'admin') {
                    // Desktop menu items for admin
                    navMenu.innerHTML = `
                        <a href="#" class="text-gray-700 dark:text-gray-200 hover:text-primary dark:hover:text-primary">Dashboard</a>
                        <a href="#" class="text-gray-700 dark:text-gray-200 hover:text-primary dark:hover:text-primary">Users</a>
                        <a href="#" class="text-gray-700 dark:text-gray-200 hover:text-primary dark:hover:text-primary">Groups</a>
                        <a href="#" class="text-gray-700 dark:text-gray-200 hover:text-primary dark:hover:text-primary">Export</a>
                    `;
                    
                    // Mobile menu items for admin
                    mobileMenu.innerHTML = `
                        <a href="#" class="block px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Dashboard</a>
                        <a href="#" class="block px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Users</a>
                        <a href="#" class="block px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Groups</a>
                        <a href="#" class="block px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Export</a>
                        <a href="#" id="mobile-logout" class="block px-4 py-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900">Logout</a>
                    `;
                    
                    // Add logout event listener to mobile menu
                    document.getElementById('mobile-logout').addEventListener('click', logoutUser);
                }
            }
            
            // =====================
            // Data Loading Functions
            // =====================
            
            // Load User Data
            async function loadUserData() {
                try {
                    const user = window.auth.currentUser;
                    
                    if (user) {
                        // Get user document from Firestore
                        const userDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'users', user.uid));
                        
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            
                            // Update user profile info
                            document.getElementById('user-name').textContent = userData.fullName;
                            document.getElementById('user-email').textContent = userData.email;
                            
                            // Set user initials
                            const initials = userData.fullName.split(' ')
                                .map(name => name.charAt(0))
                                .join('')
                                .toUpperCase();
                            document.getElementById('user-initials').textContent = initials;
                            
                            // Update profile section
                            document.getElementById('profile-name').textContent = userData.fullName;
                            document.getElementById('profile-admission').textContent = userData.admissionNumber;
                            document.getElementById('profile-email').textContent = userData.email;
                            document.getElementById('profile-phone').textContent = userData.phone;
                            document.getElementById('profile-status').textContent = userData.status;
                            
                            // Update status badge color
                            const statusBadge = document.getElementById('profile-status');
                            if (userData.status === 'Active') {
                                statusBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                            } else {
                                statusBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                            }
                            
                            // Format and display last login time
                            const lastLogin = new Date(userData.lastLogin);
                            document.getElementById('profile-last-login').textContent = lastLogin.toLocaleString();
                            
                            // Load user's group data
                            await loadUserGroupData(userData.groupId);
                        }
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    window.showNotification('Error loading user data: ' + error.message, 'error');
                }
            }
            
            // Load User Group Data
            async function loadUserGroupData(groupId) {
                try {
                    // Clear available groups
                    const availableGroupsContainer = document.getElementById('available-groups');
                    availableGroupsContainer.innerHTML = '';
                    
                    // Load all groups
                    const groupsSnapshot = await window.firebase.firestore.getDocs(window.firebase.firestore.collection(window.firestore, 'groups'));
                    
                    if (groupsSnapshot.empty) {
                        availableGroupsContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No groups available.</p>';
                        return;
                    }
                    
                    // Check if user is in a group
                    const noGroupMessage = document.getElementById('no-group-message');
                    const currentGroupDetails = document.getElementById('current-group-details');
                    const noChatGroupMessage = document.getElementById('no-chat-group-message');
                    const chatInterface = document.getElementById('chat-interface');
                    
                    if (groupId) {
                        // User is in a group
                        noGroupMessage.classList.add('hidden');
                        currentGroupDetails.classList.remove('hidden');
                        noChatGroupMessage.classList.add('hidden');
                        chatInterface.classList.remove('hidden');
                        
                        // Get group data
                        const groupDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'groups', groupId));
                        
                        if (groupDoc.exists()) {
                            const groupData = groupDoc.data();
                            
                            // Update current group info
                            document.getElementById('current-group-name').textContent = groupData.name;
                            document.getElementById('current-group-description').textContent = groupData.description;
                            
                            // Load group members
                            const membersContainer = document.getElementById('current-group-members');
                            membersContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Loading members...</p>';
                            
                            // Query users in this group
                            const q = window.firebase.firestore.query(
                                window.firebase.firestore.collection(window.firestore, 'users'),
                                window.firebase.firestore.where('groupId', '==', groupId)
                            );
                            
                            const membersSnapshot = await window.firebase.firestore.getDocs(q);
                            
                            if (membersSnapshot.empty) {
                                membersContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No members found.</p>';
                            } else {
                                membersContainer.innerHTML = '';
                                membersSnapshot.forEach(doc => {
                                    const memberData = doc.data();
                                    membersContainer.innerHTML += `
                                        <div class="flex items-center mb-1">
                                            <span class="w-6 h-6 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center text-xs font-bold text-primary mr-2">
                                                ${memberData.fullName.charAt(0).toUpperCase()}
                                            </span>
                                            <span>${memberData.fullName}</span>
                                        </div>
                                    `;
                                });
                            }
                            
                            // Load chat messages
                            loadGroupChatMessages(groupId);
                        }
                    } else {
                        // User is not in a group
                        noGroupMessage.classList.remove('hidden');
                        currentGroupDetails.classList.add('hidden');
                        noChatGroupMessage.classList.remove('hidden');
                        chatInterface.classList.add('hidden');
                    }
                    
                    // Display available groups
                    groupsSnapshot.forEach(doc => {
                        const groupData = doc.data();
                        const groupElement = document.createElement('div');
                        groupElement.className = 'p-4 border border-gray-200 dark:border-gray-700 rounded-lg';
                        
                        // Check if this is the user's current group
                        const isCurrentGroup = doc.id === groupId;
                        
                        groupElement.innerHTML = `
                            <h4 class="text-lg font-semibold">${groupData.name}</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">${groupData.description}</p>
                            <div class="flex items-center justify-between text-sm">
                                <span>Members: ${groupData.memberCount || 0}/${groupData.capacity || 'Unlimited'}</span>
                                ${isCurrentGroup ?
                                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Current Group</span>' :
                                    `<button data-group-id="${doc.id}" class="join-group-btn px-3 py-1 bg-primary hover:bg-secondary text-white rounded-md text-sm">Join Group</button>`
                                }
                            </div>
                        `;
                        
                        availableGroupsContainer.appendChild(groupElement);
                    });
                    
                    // Add event listeners to join group buttons
                    document.querySelectorAll('.join-group-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const groupId = e.target.getAttribute('data-group-id');
                            await joinGroup(groupId);
                        });
                    });
                    
                } catch (error) {
                    console.error('Error loading group data:', error);
                    window.showNotification('Error loading group data: ' + error.message, 'error');
                }
            }
            
            // Join Group Function
            async function joinGroup(groupId) {
                try {
                    const user = window.auth.currentUser;
                    
                    if (!user) {
                        window.showNotification('You must be logged in to join a group', 'error');
                        return;
                    }
                    
                    // Get group document to check capacity
                    const groupDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'groups', groupId));
                    
                    if (!groupDoc.exists()) {
                        window.showNotification('Group not found', 'error');
                        return;
                    }
                    
                    const groupData = groupDoc.data();
                    
                    // Check if group is full
                    if (groupData.capacity && groupData.memberCount >= groupData.capacity) {
                        window.showNotification('This group is full', 'error');
                        return;
                    }
                    
                    // Get user's current group
                    const userDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'users', user.uid));
                    const userData = userDoc.data();
                    const currentGroupId = userData.groupId;
                    
                    // If user is already in a group, leave it
                    if (currentGroupId) {
                        // Decrease member count in current group
                        const currentGroupDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'groups', currentGroupId));
                        
                        if (currentGroupDoc.exists()) {
                            await window.firebase.firestore.updateDoc(window.firebase.firestore.doc(window.firestore, 'groups', currentGroupId), {
                                memberCount: Math.max(0, (currentGroupDoc.data().memberCount || 1) - 1)
                            });
                        }
                    }
                    
                    // Join new group
                    await window.firebase.firestore.updateDoc(window.firebase.firestore.doc(window.firestore, 'users', user.uid), {
                        groupId: groupId
                    });
                    
                    // Increase member count in new group
                    await window.firebase.firestore.updateDoc(window.firebase.firestore.doc(window.firestore, 'groups', groupId), {
                        memberCount: (groupData.memberCount || 0) + 1
                    });
                    
                    // Show success notification
                    window.showNotification(`You've joined ${groupData.name}`, 'success');
                    
                    // Reload user group data
                    await loadUserGroupData(groupId);
                    
                } catch (error) {
                    console.error('Error joining group:', error);
                    window.showNotification('Error joining group: ' + error.message, 'error');
                }
            }
            
            // Load Group Chat Messages
            async function loadGroupChatMessages(groupId) {
                try {
                    const chatMessages = document.getElementById('chat-messages');
                    chatMessages.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 text-sm my-2">Loading messages...</p>';
                    
                    // Set up real-time listener for chat messages
                    const messagesRef = window.firebase.db.ref(window.db, `chats/${groupId}/messages`);
                    
                    window.firebase.db.onValue(messagesRef, (snapshot) => {
                        chatMessages.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 text-sm my-2">Welcome to the group chat!</p>';
                        
                        const messages = snapshot.val();
                        
                        if (messages) {
                            // Convert messages object to array and sort by timestamp
                            const messagesArray = Object.entries(messages).map(([id, message]) => ({
                                id,
                                ...message
                            })).sort((a, b) => a.timestamp - b.timestamp);
                            
                            // Display messages
                            messagesArray.forEach(message => {
                                const isCurrentUser = message.senderId === window.auth.currentUser.uid;
                                const messageElement = document.createElement('div');
                                messageElement.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mb-2`;
                                
                                const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                                
                                messageElement.innerHTML = `
                                    <div class="${isCurrentUser ? 'bg-primary text-white' : 'bg-gray-200 dark:bg-gray-700'} rounded-lg px-3 py-2 max-w-[70%]">
                                        ${!isCurrentUser ? `<p class="text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">${message.senderName}</p>` : ''}
                                        <p>${message.text}</p>
                                        <p class="text-xs text-right ${isCurrentUser ? 'text-blue-100' : 'text-gray-500 dark:text-gray-400'} mt-1">${time}</p>
                                    </div>
                                `;
                                
                                chatMessages.appendChild(messageElement);
                            });
                            
                            // Scroll to bottom
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    });
                    
                    // Set up send message functionality
                    const chatInput = document.getElementById('chat-input');
                    const sendButton = document.getElementById('send-message');
                    
                    const sendMessage = async () => {
                        const messageText = chatInput.value.trim();
                        
                        if (messageText) {
                            try {
                                const user = window.auth.currentUser;
                                
                                if (!user) {
                                    return;
                                }
                                
                                // Get user data for sender name
                                const userDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'users', user.uid));
                                const userData = userDoc.data();
                                
                                // Create message object
                                const message = {
                                    text: messageText,
                                    senderId: user.uid,
                                    senderName: userData.fullName,
                                    timestamp: Date.now()
                                };
                                
                                // Add message to database
                                const newMessageRef = window.firebase.db.push(window.firebase.db.ref(window.db, `chats/${groupId}/messages`));
                                await window.firebase.db.set(newMessageRef, message);
                                
                                // Clear input
                                chatInput.value = '';
                                
                            } catch (error) {
                                console.error('Error sending message:', error);
                                window.showNotification('Error sending message: ' + error.message, 'error');
                            }
                        }
                    };
                    
                    // Event listener for send button
                    sendButton.onclick = sendMessage;
                    
                    // Event listener for Enter key
                    chatInput.onkeydown = (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            sendMessage();
                        }
                    };
                    
                } catch (error) {
                    console.error('Error loading chat messages:', error);
                    window.showNotification('Error loading chat messages: ' + error.message, 'error');
                }
            }
            
            // Load Admin Dashboard Data
            async function loadAdminDashboardData() {
                try {
                    // Load counts for dashboard overview
                    const usersSnapshot = await window.firebase.firestore.getDocs(window.firebase.firestore.collection(window.firestore, 'users'));
                    const groupsSnapshot = await window.firebase.firestore.getDocs(window.firebase.firestore.collection(window.firestore, 'groups'));
                    
                    const totalUsers = usersSnapshot.size;
                    const totalGroups = groupsSnapshot.size;
                    
                    // Count users without a group
                    let ungroupedUsers = 0;
                    usersSnapshot.forEach(doc => {
                        if (!doc.data().groupId) {
                            ungroupedUsers++;
                        }
                    });
                    
                    // Update dashboard counts
                    document.getElementById('total-users-count').textContent = totalUsers;
                    document.getElementById('total-groups-count').textContent = totalGroups;
                    document.getElementById('ungrouped-users-count').textContent = ungroupedUsers;
                    
                    // Load users for user management
                    const usersTableBody = document.getElementById('users-table-body');
                    
                    if (usersSnapshot.empty) {
                        usersTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">No users found.</td></tr>';
                    } else {
                        usersTableBody.innerHTML = '';
                        
                        // Create a map of group IDs to names for faster lookup
                        const groupsMap = {};
                        groupsSnapshot.forEach(doc => {
                            groupsMap[doc.id] = doc.data().name;
                        });
                        
                        usersSnapshot.forEach(doc => {
                            const userData = doc.data();
                            const userRow = document.createElement('tr');
                            
                            // Get group name if user is in a group
                            const groupName = userData.groupId ? (groupsMap[userData.groupId] || 'Unknown') : 'None';
                            
                            userRow.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="h-10 w-10 flex-shrink-0 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center">
                                            <span class="text-sm font-medium text-primary">${userData.fullName.split(' ').map(n => n[0]).join('').toUpperCase()}</span>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium">${userData.fullName}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm">${userData.admissionNumber}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm">${userData.email}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm">${groupName}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                        userData.status === 'Active' ? 
                                        'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 
                                        'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                                    }">
                                        ${userData.status}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <div class="flex justify-end space-x-2">
                                        <button data-user-id="${doc.id}" class="edit-user-btn text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                                            Edit
                                        </button>
                                        <button data-user-id="${doc.id}" data-user-name="${userData.fullName}" class="delete-user-btn text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                            Delete
                                        </button>
                                        <button data-user-id="${doc.id}" data-user-name="${userData.fullName}" class="shift-user-btn text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300">
                                            Shift
                                        </button>
                                    </div>
                                </td>
                            `;
                            
                            usersTableBody.appendChild(userRow);
                        });
                        
                        // Add event listeners for user management buttons
                        attachUserManagementListeners();
                    }
                    
                    // Load groups for group management
                    const adminGroupsList = document.getElementById('admin-groups-list');
                    
                    if (groupsSnapshot.empty) {
                        adminGroupsList.innerHTML = '<div class="col-span-full text-center text-gray-500 dark:text-gray-400">No groups found.</div>';
                    } else {
                        adminGroupsList.innerHTML = '';
                        
                        groupsSnapshot.forEach(doc => {
                            const groupData = doc.data();
                            const groupCard = document.createElement('div');
                            groupCard.className = 'p-4 border border-gray-200 dark:border-gray-700 rounded-lg';
                            
                            groupCard.innerHTML = `
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="text-lg font-semibold">${groupData.name}</h4>
                                    <div class="flex space-x-1">
                                        <button data-group-id="${doc.id}" class="edit-group-btn p-1 text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                            </svg>
                                        </button>
                                        <button data-group-id="${doc.id}" data-group-name="${groupData.name}" class="delete-group-btn p-1 text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">${groupData.description}</p>
                                <div class="flex justify-between items-center text-sm">
                                    <span>Members: ${groupData.memberCount || 0}/${groupData.capacity || 'Unlimited'}</span>
                                    <button data-group-id="${doc.id}" class="view-members-btn px-2 py-1 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 rounded text-xs">
                                        View Members
                                    </button>
                                </div>
                            `;
                            
                            adminGroupsList.appendChild(groupCard);
                        });
                        
                        // Add event listeners for group management buttons
                        attachGroupManagementListeners();
                    }
                    
                } catch (error) {
                    console.error('Error loading admin dashboard data:', error);
                    window.showNotification('Error loading admin dashboard data: ' + error.message, 'error');
                }
            }
            
            // Attach User Management Listeners
            function attachUserManagementListeners() {
                // Edit User
                document.querySelectorAll('.edit-user-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const userId = e.target.getAttribute('data-user-id');
                        editUser(userId);
                    });
                });
                
                // Delete User
                document.querySelectorAll('.delete-user-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const userId = e.target.getAttribute('data-user-id');
                        const userName = e.target.getAttribute('data-user-name');
                        deleteUser(userId, userName);
                    });
                });
                
                // Shift User
                document.querySelectorAll('.shift-user-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const userId = e.target.getAttribute('data-user-id');
                        const userName = e.target.getAttribute('data-user-name');
                        shiftUser(userId, userName);
                    });
                });
                
                // Export Users
                document.getElementById('export-users-btn').addEventListener('click', exportUsers);
                
                // User Search
                document.getElementById('user-search').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#users-table-body tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
            }
            
            // Attach Group Management Listeners
            function attachGroupManagementListeners() {
                // Create Group
                document.getElementById('create-group-btn').addEventListener('click', createGroup);
                
                // Edit Group
                document.querySelectorAll('.edit-group-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const groupId = e.target.closest('.edit-group-btn').getAttribute('data-group-id');
                        editGroup(groupId);
                    });
                });
                
                // Delete Group
                document.querySelectorAll('.delete-group-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const groupId = e.target.closest('.delete-group-btn').getAttribute('data-group-id');
                        const groupName = e.target.closest('.delete-group-btn').getAttribute('data-group-name');
                        deleteGroup(groupId, groupName);
                    });
                });
                
                // View Group Members
                document.querySelectorAll('.view-members-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const groupId = e.target.getAttribute('data-group-id');
                        viewGroupMembers(groupId);
                    });
                });
                
                // Export All Groups
                document.getElementById('export-all-data-btn').addEventListener('click', exportAllGroups);
            }
            
            // =====================
            // User Management Functions
            // =====================
            
            // Edit User
            async function editUser(userId) {
                try {
                    // Get user data
                    const userDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'users', userId));
                    
                    if (!userDoc.exists()) {
                        window.showNotification('User not found', 'error');
                        return;
                    }
                    
                    const userData = userDoc.data();
                    
                    // Get groups for dropdown
                    const groupsSnapshot = await window.firebase.firestore.getDocs(window.firebase.firestore.collection(window.firestore, 'groups'));
                    
                    let groupOptions = '<option value="">None</option>';
                    groupsSnapshot.forEach(doc => {
                        const selected = doc.id === userData.groupId ? 'selected' : '';
                        groupOptions += `<option value="${doc.id}" ${selected}>${doc.data().name}</option>`;
                    });
                    
                    // Create edit form
                    const modalContent = `
                        <form id="edit-user-form" class="space-y-4">
                            <div>
                                <label for="edit-name" class="block text-sm font-medium mb-1">Full Name</label>
                                <input type="text" id="edit-name" value="${userData.fullName}" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white" required>
                            </div>
                            <div>
                                <label for="edit-admission" class="block text-sm font-medium mb-1">Admission Number</label>
                                <input type="text" id="edit-admission" value="${userData.admissionNumber}" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white" required>
                            </div>
                            <div>
                                <label for="edit-email" class="block text-sm font-medium mb-1">Email</label>
                                <input type="email" id="edit-email" value="${userData.email}" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white" required>
                            </div>
                            <div>
                                <label for="edit-phone" class="block text-sm font-medium mb-1">Phone Number</label>
                                <input type="tel" id="edit-phone" value="${userData.phone}" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white" required>
                            </div>
                            <div>
                                <label for="edit-status" class="block text-sm font-medium mb-1">Status</label>
                                <select id="edit-status" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white">
                                    <option value="Active" ${userData.status === 'Active' ? 'selected' : ''}>Active</option>
                                    <option value="Inactive" ${userData.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                </select>
                            </div>
                            <div>
                                <label for="edit-group" class="block text-sm font-medium mb-1">Group</label>
                                <select id="edit-group" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white">
                                    ${groupOptions}
                                </select>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="edit-admin" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" ${userData.isAdmin ? 'checked' : ''}>
                                <label for="edit-admin" class="ml-2 block text-sm">Administrator</label>
                            </div>
                        </form>
                    `;
                    
                    // Show modal with form
                    window.showModal('Edit User', modalContent, 'Save Changes', 'Cancel', async () => {
                        try {
                            // Get form values
                            const fullName = document.getElementById('edit-name').value;
                            const admissionNumber = document.getElementById('edit-admission').value;
                            const email = document.getElementById('edit-email').value;
                            const phone = document.getElementById('edit-phone').value;
                            const status = document.getElementById('edit-status').value;
                            const groupId = document.getElementById('edit-group').value || null;
                            const isAdmin = document.getElementById('edit-admin').checked;
                            
                            // Check if group changed
                            if (groupId !== userData.groupId) {
                                // Update old group member count if user was in a group
                                if (userData.groupId) {
                                    const oldGroupDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'groups', userData.groupId));
                                    
                                    if (oldGroupDoc.exists()) {
                                        await window.firebase.firestore.updateDoc(window.firebase.firestore.doc(window.firestore, 'groups', userData.groupId), {
                                            memberCount: Math.max(0, (oldGroupDoc.data().memberCount || 1) - 1)
                                        });
                                    }
                                }
                                
                                // Update new group member count if user is joining a group
                                if (groupId) {
                                    const newGroupDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'groups', groupId));
                                    
                                    if (newGroupDoc.exists()) {
                                        await window.firebase.firestore.updateDoc(window.firebase.firestore.doc(window.firestore, 'groups', groupId), {
                                            memberCount: (newGroupDoc.data().memberCount || 0) + 1
                                        });
                                    }
                                }
                            }
                            
                            // Update user document
                            await window.firebase.firestore.updateDoc(window.firebase.firestore.doc(window.firestore, 'users', userId), {
                                fullName,
                                admissionNumber,
                                email,
                                phone,
                                status,
                                groupId,
                                isAdmin
                            });
                            
                            // Show success notification
                            window.showNotification('User updated successfully', 'success');
                            
                            // Reload admin dashboard data
                            loadAdminDashboardData();
                            
                        } catch (error) {
                            console.error('Error updating user:', error);
                            window.showNotification('Error updating user: ' + error.message, 'error');
                        }
                    });
                    
                } catch (error) {
                    console.error('Error editing user:', error);
                    window.showNotification('Error editing user: ' + error.message, 'error');
                }
            }
            
            // Delete User
            function deleteUser(userId, userName) {
                // Show confirmation modal
                window.showModal(
                    'Delete User',
                    `<p>Are you sure you want to delete user <strong>${userName}</strong>?</p><p class="text-red-500 mt-2">This action cannot be undone.</p>`,
                    'Delete',
                    'Cancel',
                    async () => {
                        try {
                            // Get user data to update group member count
                            const userDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'users', userId));
                            
                            if (userDoc.exists()) {
                                const userData = userDoc.data();
                                
                                // Update group member count if user was in a group
                                if (userData.groupId) {
                                    const groupDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'groups', userData.groupId));
                                    
                                    if (groupDoc.exists()) {
                                        await window.firebase.firestore.updateDoc(window.firebase.firestore.doc(window.firestore, 'groups', userData.groupId), {
                                            memberCount: Math.max(0, (groupDoc.data().memberCount || 1) - 1)
                                        });
                                    }
                                }
                            }
                            
                            // Delete user document
                            await window.firebase.firestore.deleteDoc(window.firebase.firestore.doc(window.firestore, 'users', userId));
                            
                            // Show success notification
                            window.showNotification('User deleted successfully', 'success');
                            
                            // Reload admin dashboard data
                            loadAdminDashboardData();
                            
                        } catch (error) {
                            console.error('Error deleting user:', error);
                            window.showNotification('Error deleting user: ' + error.message, 'error');
                        }
                    }
                );
            }
            
            // Shift User
            async function shiftUser(userId, userName) {
                try {
                    // Get user data
                    const userDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'users', userId));
                    
                    if (!userDoc.exists()) {
                        window.showNotification('User not found', 'error');
                        return;
                    }
                    
                    const userData = userDoc.data();
                    
                    // Get groups for dropdown
                    const groupsSnapshot = await window.firebase.firestore.getDocs(window.firebase.firestore.collection(window.firestore, 'groups'));
                    
                    let groupOptions = '<option value="">None</option>';
                    groupsSnapshot.forEach(doc => {
                        const selected = doc.id === userData.groupId ? 'selected' : '';
                        groupOptions += `<option value="${doc.id}" ${selected}>${doc.data().name}</option>`;
                    });
                    
                    // Create shift form
                    const modalContent = `
                        <p class="mb-4">Shift user <strong>${userName}</strong> to a different group:</p>
                        <form id="shift-user-form" class="space-y-4">
                            <div>
                                <label for="shift-group" class="block text-sm font-medium mb-1">Select Group</label>
                                <select id="shift-group" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white">
                                    ${groupOptions}
                                </select>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="bypass-limit" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                                <label for="bypass-limit" class="ml-2 block text-sm">Bypass group capacity limit</label>
                            </div>
                        </form>
                    `;
                    
                    // Show modal with form
                    window.showModal('Shift User', modalContent, 'Shift User', 'Cancel', async () => {
                        try {
                            // Get form values
                            const newGroupId = document.getElementById('shift-group').value || null;
                            const bypassLimit = document.getElementById('bypass-limit').checked;
                            
                            // If no change in group, do nothing
                            if (newGroupId === userData.groupId) {
                                window.showNotification('User is already in this group', 'info');
                                return;
                            }
                            
                            // Check if new group is full (if not bypassing limit)
                            if (newGroupId && !bypassLimit) {
                                const newGroupDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'groups', newGroupId));
                                
                                if (newGroupDoc.exists()) {
                                    const groupData = newGroupDoc.data();
                                    
                                    if (groupData.capacity && groupData.memberCount >= groupData.capacity) {
                                        window.showNotification('This group is full. Use bypass option to add anyway.', 'error');
                                        return;
                                    }
                                }
                            }
                            
                            // Update old group member count if user was in a group
                            if (userData.groupId) {
                                const oldGroupDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'groups', userData.groupId));
                                
                                if (oldGroupDoc.exists()) {
                                    await window.firebase.firestore.updateDoc(window.firebase.firestore.doc(window.firestore, 'groups', userData.groupId), {
                                        memberCount: Math.max(0, (oldGroupDoc.data().memberCount || 1) - 1)
                                    });
                                }
                            }
                            
                            // Update new group member count if user is joining a group
                            if (newGroupId) {
                                const newGroupDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'groups', newGroupId));
                                
                                if (newGroupDoc.exists()) {
                                    await window.firebase.firestore.updateDoc(window.firebase.firestore.doc(window.firestore, 'groups', newGroupId), {
                                        memberCount: (newGroupDoc.data().memberCount || 0) + 1
                                    });
                                }
                            }
                            
                            // Update user document
                            await window.firebase.firestore.updateDoc(window.firebase.firestore.doc(window.firestore, 'users', userId), {
                                groupId: newGroupId
                            });
                            
                            // Show success notification
                            window.showNotification('User shifted successfully', 'success');
                            
                            // Reload admin dashboard data
                            loadAdminDashboardData();
                            
                        } catch (error) {
                            console.error('Error shifting user:', error);
                            window.showNotification('Error shifting user: ' + error.message, 'error');
                        }
                    });
                    
                } catch (error) {
                    console.error('Error preparing to shift user:', error);
                    window.showNotification('Error preparing to shift user: ' + error.message, 'error');
                }
            }
            
            // Export Users
            async function exportUsers() {
                try {
                    // Get all users
                    const usersSnapshot = await window.firebase.firestore.getDocs(window.firebase.firestore.collection(window.firestore, 'users'));
                    
                    if (usersSnapshot.empty) {
                        window.showNotification('No users to export', 'warning');
                        return;
                    }
                    
                    // Get all groups for mapping group IDs to names
                    const groupsSnapshot = await window.firebase.firestore.getDocs(window.firebase.firestore.collection(window.firestore, 'groups'));
                    const groupsMap = {};
                    groupsSnapshot.forEach(doc => {
                        groupsMap[doc.id] = doc.data().name;
                    });
                    
                    // Generate CSV data
                    let csvContent = 'Full Name,Admission Number,Email,Phone Number,Group,Status,Admin,Last Login\n';
                    
                    usersSnapshot.forEach(doc => {
                        const userData = doc.data();
                        const groupName = userData.groupId ? (groupsMap[userData.groupId] || 'Unknown') : 'None';
                        const lastLogin = new Date(userData.lastLogin).toLocaleDateString() + ' ' + new Date(userData.lastLogin).toLocaleTimeString();
                        
                        // Escape CSV fields
                        const escapeCsv = (field) => {
                            if (field === null || field === undefined) return '';
                            return `"${String(field).replace(/"/g, '""')}"`;
                        };
                        
                        csvContent += `${escapeCsv(userData.fullName)},${escapeCsv(userData.admissionNumber)},${escapeCsv(userData.email)},${escapeCsv(userData.phone)},${escapeCsv(groupName)},${escapeCsv(userData.status)},${escapeCsv(userData.isAdmin ? 'Yes' : 'No')},${escapeCsv(lastLogin)}\n`;
                    });
                    
                    // Show CSV in download modal
                    const modalContent = `
                        <p class="mb-4">Users exported as CSV format:</p>
                        <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-md overflow-auto max-h-60 text-xs font-mono whitespace-pre">
                            ${csvContent.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                        </div>
                        <p class="mt-4 text-sm text-gray-500">Right-click the text above and select "Save as..." to download.</p>
                    `;
                    
                    window.showModal('Export Users', modalContent, 'Close', '', null);
                    
                } catch (error) {
                    console.error('Error exporting users:', error);
                    window.showNotification('Error exporting users: ' + error.message, 'error');
                }
            }
            
            // =====================
            // Group Management Functions
            // =====================
            
            // Create Group
            function createGroup() {
                // Create form for new group
                const modalContent = `
                    <form id="create-group-form" class="space-y-4">
                        <div>
                            <label for="group-name" class="block text-sm font-medium mb-1">Group Name</label>
                            <input type="text" id="group-name" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white" required>
                        </div>
                        <div>
                            <label for="group-description" class="block text-sm font-medium mb-1">Description</label>
                            <textarea id="group-description" rows="3" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white"></textarea>
                        </div>
                        <div>
                            <label for="group-capacity" class="block text-sm font-medium mb-1">Capacity</label>
                            <input type="number" id="group-capacity" min="1" value="11" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white">
                            <p class="text-xs text-gray-500 mt-1">Leave blank for unlimited capacity</p>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="group-chat" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" checked>
                            <label for="group-chat" class="ml-2 block text-sm">Enable chat for this group</label>
                        </div>
                    </form>
                `;
                
                // Show modal with form
                window.showModal('Create New Group', modalContent, 'Create Group', 'Cancel', async () => {
                    try {
                        // Get form values
                        const name = document.getElementById('group-name').value;
                        const description = document.getElementById('group-description').value;
                        const capacityInput = document.getElementById('group-capacity').value;
                        const capacity = capacityInput ? parseInt(capacityInput) : null;
                        const chatEnabled = document.getElementById('group-chat').checked;
                        
                        // Create group document
                        const newGroupRef = window.firebase.firestore.doc(window.firebase.firestore.collection(window.firestore, 'groups'));
                        
                        await window.firebase.firestore.setDoc(newGroupRef, {
                            name,
                            description,
                            capacity,
                            memberCount: 0,
                            chatEnabled,
                            createdAt: new Date().toISOString()
                        });
                        
                        // Show success notification
                        window.showNotification('Group created successfully', 'success');
                        
                        // Reload admin dashboard data
                        loadAdminDashboardData();
                        
                    } catch (error) {
                        console.error('Error creating group:', error);
                        window.showNotification('Error creating group: ' + error.message, 'error');
                    }
                });
            }
            
            // Edit Group
            async function editGroup(groupId) {
                try {
                    // Get group data
                    const groupDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'groups', groupId));
                    
                    if (!groupDoc.exists()) {
                        window.showNotification('Group not found', 'error');
                        return;
                    }
                    
                    const groupData = groupDoc.data();
                    
                    // Create edit form
                    const modalContent = `
                        <form id="edit-group-form" class="space-y-4">
                            <div>
                                <label for="edit-group-name" class="block text-sm font-medium mb-1">Group Name</label>
                                <input type="text" id="edit-group-name" value="${groupData.name}" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white" required>
                            </div>
                            <div>
                                <label for="edit-group-description" class="block text-sm font-medium mb-1">Description</label>
                                <textarea id="edit-group-description" rows="3" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white">${groupData.description || ''}</textarea>
                            </div>
                            <div>
                                <label for="edit-group-capacity" class="block text-sm font-medium mb-1">Capacity</label>
                                <input type="number" id="edit-group-capacity" min="1" value="${groupData.capacity || ''}" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-black dark:bg-gray-700 dark:text-white">
                                <p class="text-xs text-gray-500 mt-1">Leave blank for unlimited capacity</p>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="edit-group-chat" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" ${groupData.chatEnabled ? 'checked' : ''}>
                                <label for="edit-group-chat" class="ml-2 block text-sm">Enable chat for this group</label>
                            </div>
                        </form>
                    `;
                    
                    // Show modal with form
                    window.showModal('Edit Group', modalContent, 'Save Changes', 'Cancel', async () => {
                        try {
                            // Get form values
                            const name = document.getElementById('edit-group-name').value;
                            const description = document.getElementById('edit-group-description').value;
                            const capacityInput = document.getElementById('edit-group-capacity').value;
                            const capacity = capacityInput ? parseInt(capacityInput) : null;
                            const chatEnabled = document.getElementById('edit-group-chat').checked;
                            
                            // Update group document
                            await window.firebase.firestore.updateDoc(window.firebase.firestore.doc(window.firestore, 'groups', groupId), {
                                name,
                                description,
                                capacity,
                                chatEnabled
                            });
                            
                            // Show success notification
                            window.showNotification('Group updated successfully', 'success');
                            
                            // Reload admin dashboard data
                            loadAdminDashboardData();
                            
                        } catch (error) {
                            console.error('Error updating group:', error);
                            window.showNotification('Error updating group: ' + error.message, 'error');
                        }
                    });
                    
                } catch (error) {
                    console.error('Error editing group:', error);
                    window.showNotification('Error editing group: ' + error.message, 'error');
                }
            }
            
            // Delete Group
            function deleteGroup(groupId, groupName) {
                // Show confirmation modal
                window.showModal(
                    'Delete Group',
                    `<p>Are you sure you want to delete group <strong>${groupName}</strong>?</p>
                    <p class="text-red-500 mt-2">This will remove all users from this group.</p>
                    <p class="text-red-500">This action cannot be undone.</p>`,
                    'Delete',
                    'Cancel',
                    async () => {
                        try {
                            // Find all users in this group
                            const q = window.firebase.firestore.query(
                                window.firebase.firestore.collection(window.firestore, 'users'),
                                window.firebase.firestore.where('groupId', '==', groupId)
                            );
                            
                            const usersSnapshot = await window.firebase.firestore.getDocs(q);
                            
                            // Update users to remove group association
                            const batch = window.firebase.app.firestore().batch();
                            
                            usersSnapshot.forEach(doc => {
                                const userRef = window.firebase.firestore.doc(window.firestore, 'users', doc.id);
                                batch.update(userRef, { groupId: null });
                            });
                            
                            // Commit batch update
                            await batch.commit();
                            
                            // Delete group chat data if it exists
                            const chatRef = window.firebase.db.ref(window.db, `chats/${groupId}`);
                            await window.firebase.db.remove(chatRef);
                            
                            // Delete group document
                            await window.firebase.firestore.deleteDoc(window.firebase.firestore.doc(window.firestore, 'groups', groupId));
                            
                            // Show success notification
                            window.showNotification('Group deleted successfully', 'success');
                            
                            // Reload admin dashboard data
                            loadAdminDashboardData();
                            
                        } catch (error) {
                            console.error('Error deleting group:', error);
                            window.showNotification('Error deleting group: ' + error.message, 'error');
                        }
                    }
                );
            }
            
            // View Group Members
            async function viewGroupMembers(groupId) {
                try {
                    // Get group data
                    const groupDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'groups', groupId));
                    
                    if (!groupDoc.exists()) {
                        window.showNotification('Group not found', 'error');
                        return;
                    }
                    
                    const groupData = groupDoc.data();
                    
                    // Get members in this group
                    const q = window.firebase.firestore.query(
                        window.firebase.firestore.collection(window.firestore, 'users'),
                        window.firebase.firestore.where('groupId', '==', groupId)
                    );
                    
                    const membersSnapshot = await window.firebase.firestore.getDocs(q);
                    
                    let membersHtml = '';
                    
                    if (membersSnapshot.empty) {
                        membersHtml = '<p class="text-gray-500 dark:text-gray-400">No members in this group.</p>';
                    } else {
                        membersHtml = '<div class="space-y-2">';
                        membersSnapshot.forEach(doc => {
                            const memberData = doc.data();
                            membersHtml += `
                                <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-800 rounded-md">
                                    <div class="flex items-center">
                                        <div class="h-8 w-8 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center text-xs font-bold text-primary mr-2">
                                            ${memberData.fullName.split(' ').map(n => n[0]).join('').toUpperCase()}
                                        </div>
                                        <div>
                                            <p class="font-medium">${memberData.fullName}</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">${memberData.admissionNumber}</p>
                                        </div>
                                    </div>
                                    <button data-user-id="${doc.id}" data-user-name="${memberData.fullName}" class="shift-from-view-btn px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 dark:bg-blue-900 dark:hover:bg-blue-800 text-blue-700 dark:text-blue-300 rounded">
                                        Shift
                                    </button>
                                </div>
                            `;
                        });
                        membersHtml += '</div>';
                    }
                    
                    // Create modal content
                    const modalContent = `
                        <div>
                            <div class="mb-4">
                                <h4 class="text-lg font-semibold">${groupData.name}</h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${groupData.description || ''}</p>
                                <p class="text-sm mt-1">Members: ${groupData.memberCount || 0}/${groupData.capacity || 'Unlimited'}</p>
                            </div>
                            <div class="max-h-60 overflow-y-auto">
                                ${membersHtml}
                            </div>
                        </div>
                    `;
                    
                    // Show modal
                    window.showModal(`Group Members: ${groupData.name}`, modalContent, 'Close', '', null);
                    
                    // Add event listeners to shift buttons
                    document.querySelectorAll('.shift-from-view-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            // Close the current modal
                            document.getElementById('modal-container').classList.add('hidden');
                            
                            // Open shift user modal
                            const userId = e.target.getAttribute('data-user-id');
                            const userName = e.target.getAttribute('data-user-name');
                            shiftUser(userId, userName);
                        });
                    });
                    
                } catch (error) {
                    console.error('Error viewing group members:', error);
                    window.showNotification('Error viewing group members: ' + error.message, 'error');
                }
            }
            
            // Export All Groups
            async function exportAllGroups() {
                try {
                    // Get all groups
                    const groupsSnapshot = await window.firebase.firestore.getDocs(window.firebase.firestore.collection(window.firestore, 'groups'));
                    
                    if (groupsSnapshot.empty) {
                        window.showNotification('No groups to export', 'warning');
                        return;
                    }
                    
                    // Generate CSV data with sheets for each group
                    let csvContent = '';
                    
                    // Create a header row with metadata
                    csvContent += 'Group Management System - Export Date: ' + new Date().toLocaleString() + '\n\n';
                    
                    // Process each group
                    for (const groupDoc of groupsSnapshot.docs) {
                        const groupData = groupDoc.data();
                        csvContent += `Group: ${groupData.name}\n`;
                        csvContent += `Description: ${groupData.description || 'N/A'}\n`;
                        csvContent += `Capacity: ${groupData.capacity || 'Unlimited'}\n`;
                        csvContent += `Members: ${groupData.memberCount || 0}\n\n`;
                        
                        // Add member list header
                        csvContent += 'Admission Number,Name,Phone\n';
                        
                        // Get members in this group
                        const q = window.firebase.firestore.query(
                            window.firebase.firestore.collection(window.firestore, 'users'),
                            window.firebase.firestore.where('groupId', '==', groupDoc.id)
                        );
                        
                        const membersSnapshot = await window.firebase.firestore.getDocs(q);
                        
                        // If no members, add a note
                        if (membersSnapshot.empty) {
                            csvContent += 'No members in this group\n';
                        } else {
                            // Add member data
                            membersSnapshot.forEach(doc => {
                                const memberData = doc.data();
                                csvContent += `${memberData.admissionNumber},"${memberData.fullName}",${memberData.phone}\n`;
                            });
                        }
                        
                        // Add separator between groups
                        csvContent += '\n\n';
                    }
                    
                    // Show CSV in download modal
                    const modalContent = `
                        <p class="mb-4">All groups exported as CSV format:</p>
                        <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-md overflow-auto max-h-60 text-xs font-mono whitespace-pre">
                            ${csvContent.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                        </div>
                        <p class="mt-4 text-sm text-gray-500">Right-click the text above and select "Save as..." to download.</p>
                    `;
                    
                    window.showModal('Export All Groups', modalContent, 'Close', '', null);
                    
                } catch (error) {
                    console.error('Error exporting groups:', error);
                    window.showNotification('Error exporting groups: ' + error.message, 'error');
                }
            }
            
            // =====================
            // Initialize App
            // =====================
            
            // Set up auth state listener
            window.firebase.onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    // User is signed in
                    try {
                        // Get user document from Firestore
                        const userDoc = await window.firebase.firestore.getDoc(window.firebase.firestore.doc(window.firestore, 'users', user.uid));
                        
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            
                            // Check user role
                            if (userData.isAdmin) {
                                // Show admin dashboard
                                showAdminDashboard();
                            } else {
                                // Show user dashboard
                                showUserDashboard();
                            }
                        } else {
                            // No user document, show login
                            showLoginPage();
                        }
                    } catch (error) {
                        console.error('Error checking user role:', error);
                        showLoginPage();
                    }
                } else {
                    // User is signed out
                    showLoginPage();
                }
            });
            
            // Create predefined groups if they don't exist
            async function setupPredefinedGroups() {
                try {
                    // Check if groups collection is empty
                    const groupsSnapshot = await window.firebase.firestore.getDocs(window.firebase.firestore.collection(window.firestore, 'groups'));
                    
                    if (groupsSnapshot.empty) {
                        // Create 11 predefined groups
                        const groupPromises = [];
                        
                        for (let i = 1; i <= 11; i++) {
                            const groupData = {
                                name: `Group ${i}`,
                                description: `Predefined group ${i}`,
                                capacity: 11,
                                memberCount: 0,
                                chatEnabled: true,
                                createdAt: new Date().toISOString()
                            };
                            
                            const newGroupRef = window.firebase.firestore.doc(window.firebase.firestore.collection(window.firestore, 'groups'));
                            groupPromises.push(window.firebase.firestore.setDoc(newGroupRef, groupData));
                        }
                        
                        await Promise.all(groupPromises);
                        console.log('Predefined groups created');
                    }
                } catch (error) {
                    console.error('Error setting up predefined groups:', error);
                }
            }
            
            // Call setup function
            setupPredefinedGroups();
        });
    </script>
</body>
</html>
